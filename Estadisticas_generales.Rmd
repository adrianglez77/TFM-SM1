---
title: "Estadísticas_generales"
author: "Adrián González"
date: "2024-04-18"
output:
  html_document: default
  pdf_document: default
---


```{r}
library(DT)
library(tidyverse)
library(magrittr)
library(shiny)
library(openxlsx)
library(dplyr)
library(datavolley)
library(DataEditR)
library(ovscout2)
library(datavolleyXtra)
library(ggplot2)
library(httr)
library(ggimage)
library(gt)
library(gtExtras)
library(purrr)
library(tibble)
library(kableExtra)
library(knitr)
library(gt)
library(webshot)
library(htmltools)
library(gridExtra)
library(grid)
library(png)
library(curl)
library(stringr)
library(ggrepel)

ruta_archivo <- "dvws"

if (file.exists(ruta_archivo)) {
  df <- dv_readXtra(ruta_archivo)
} else {
  print("El archivo no existe en la ruta especificada.")
}

```


```{r}
# Dejar el dataframe en minúsculas, sin guiones, con espacios, etc...
df <- df %>%
  mutate_all(tolower) %>%  # Todo a minúsculas
  mutate(
    team = gsub("-", " ", team),
    team = gsub("\\s+", " ", team),
    team = case_when(
      team == "upv leleman conqueridor" ~ "leleman conqueridor upv",
      team == "melilla sport capital" ~ "cv melilla",
      team == "arenal emevac" ~ "arenal emevé",
      team == "club va3ley palma" ~ "club vóley palma",
      team == "unicaja costa de almera-a" ~ "unicaja costa de almería",
      TRUE ~ team
    ),
    point_won_by = case_when(
      point_won_by == "upv leleman conqueridor" ~ "leleman conqueridor upv",
      point_won_by == "melilla sport capital" ~ "cv melilla",
      point_won_by == "arenal emevac" ~ "arenal emevé",
      point_won_by == "club va3ley palma" ~ "club vóley palma",
      point_won_by == "unicaja costa de almera-a" ~ "unicaja costa de almería",
      TRUE ~ point_won_by
    ),
    serving_team = case_when(
      serving_team == "upv leleman conqueridor" ~ "leleman conqueridor upv",
      serving_team == "melilla sport capital" ~ "cv melilla",
      serving_team == "arenal emevac" ~ "arenal emevé",
      serving_team == "club va3ley palma" ~ "club vóley palma",
      serving_team == "unicaja costa de almera-a" ~ "unicaja costa de almería",
      TRUE ~ serving_team
    )
  )
```


```{r}
df_jugadores <- function (df){
  df$player_name <- gsub("-", " ", df$player_name)
  df$player_name <- gsub("\\s+", " ", df$player_name)
  return(df)
}
df <- df_jugadores(df)


#Informacion de los partidos importados por equipo: sets, y num partidos
teams_info <- df %>%
  filter(!is.na(team)) %>%
  group_by(team) %>%
  summarise(
    sets_played = n_distinct(paste(match_id, set_number)),
    matches_played = n_distinct(match_id)
  )%>%
  arrange(desc(sets_played))

logo_df <- data.frame(
  team = c("cv san roque", "club vóley palma", "leleman conqueridor upv", 
           "cisneros alter", "grupo herce soria", "arenal emevé", 
           "pamesa teruel voleibol", "conectabalear cv manacor", 
           "cv guaguas", "volei villena petrer", "cv melilla", 
           "unicaja costa de almería"),
  logo = c(
    "https://intranet.rfevb.com/clubes/logos/web/cl01054.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl00300.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl01313.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl01140.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl01268.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl00734.jpg",
    "https://intranet.rfevb.com/clubes/logos/web/cl01279.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl00236.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl01946.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl00125.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl01445.png",
    "https://intranet.rfevb.com/clubes/logos/web/cl00135.png"
  )
)


# Realizar la unión con teams_info
teams_info <- left_join(teams_info, logo_df, by = "team")



# Obtener la información del equipo desde el dataframe original "df"
team_player <- df %>%
  filter(!is.na(player_id)) %>%
  select(player_id, team) %>%
  distinct()


player_rol <- function(df) {
  # Añadir la nueva columna 'player_rol' con NA
  df <- df %>% mutate(player_rol = NA)
  
  # Contar ataques y recepciones por player_id y posicion
  counts <- df %>%
    group_by(player_id, position) %>%
    summarise(
      num_attack = sum(skill == "attack"),
      num_reception = sum(skill == "reception")
    )
  
  # Actualizar 'player_rol'
  df <- df %>%
    left_join(counts, by = c("player_id", "position")) %>%
    mutate(
      player_rol = case_when(
        position == "oh" ~ "outside hitter",
        position == "s" ~ "setter",
        position == "ds/l" ~ "libero",
        position == "opp" ~ "opposite",
        position == "mb" ~ "middle",
        TRUE ~ player_rol  # Mantener NA si no se cumple ninguna condicion
      )
    ) %>%
    select(-num_attack, -num_reception)  # Eliminar las columnas auxiliares
  
  return(df)
}
df <- player_rol(df)

df <- df %>%
  mutate(
    player_id = if_else(player_id == "dix-ant", "10034", player_id),
    player_name = if_else(player_name == "antonio de la rosa ca?ellas", "antonio de la rosa cañellas", player_name),
    player_name = if_else(player_name == "nicolï¿½s omar rodrï¿½guez cï¿½ceres", "nicolás omar rodríguez cáceres", player_name),
    player_name = if_else(player_name == "unai larra?aga ledo", "unai larrañaga ledo", player_name),
    player_name = if_else(player_name == "isaac vali?o sanz", "isaac valiño sanz", player_name),
    player_name = if_else(player_name == "samuel barrasa portome?e", "samuel barrasa portomeñe", player_name),
  )

#jugadores por nombre, no repetidos
players_info <- df %>%
  filter(!is.na(player_id)) %>%
  group_by(player_id) %>%  # Agrupar por player_id
  summarise(
    player_name = first(player_name),
    position = first(position), 
    player_rol = first(player_rol), 
    Player = first(Player),
    sets_played = n_distinct(paste(match_id, set_number))
  )

players_info <- players_info %>%
  mutate(player_name = str_to_title(player_name))


# Crear un dataframe con las posiciones adicionales
positions_to_add <- data.frame(
  player_id = c(1323, 150, 174, 184, 190, 2131, 269, 5523, 5669, 5720,
                5782, 6708, 6711, 6712, 6972, 7246, 7155, 7441, 7880, 7910,
                8102, 8574, 8704, 8825, 8834, 8882, 8884, 9019, 9035, 9429,
                9435, 9532, 9575, 9576, 9580, 975, 1320, 8530, 4468, "joa-val", 
                9963, 5522, 5708, 9180, 4978, 7859, 7881, 6318, 9522,9676, 8883, 9436),
  position = c("mb", "oh", "oh", "mb", "mb", "mb", "mb", "mb", "oh", "mb",
               "mb", "oh", "mb", "mb", "oh", "mb", "mb", "mb", "oh", "mb",
               "opp", "ds/l", "mb", "mb", "mb", "ds/l", "opp", "mb", "mb", "mb",
               "mb", "mb", "mb", "opp", "mb", "mb", "opp", "oh", "oh","oh","mb", 
               "mb", "s", "mb", "ds/l", "oh", "s", "ds/l","opp","mb","oh", "oh")
)

# Convertir player_id en players_info y positions_to_add a character
players_info$player_id <- as.character(players_info$player_id)
positions_to_add$player_id <- as.character(positions_to_add$player_id)

# Añadir las posiciones al dataframe players_info
players_info <- left_join(players_info, positions_to_add, by = "player_id") %>%
  mutate(position = coalesce(position.y, position.x)) %>%
  select(-position.x, -position.y)  # Eliminar las columnas auxiliares

# Actualizar 'player_rol' segun las condiciones
players_info <- players_info %>%
  mutate(
    player_rol = case_when(
      position == "oh" ~ "outside hitter",
      position == "s" ~ "setter",
      position == "ds/l" ~ "libero",
      position == "opp" ~ "opposite",
      position == "mb" ~ "middle",
      TRUE ~ player_rol  # Mantener NA si no se cumple ninguna condici?n
    )
  )

df_filtrado <- df %>%
  select(
    match_id, code, team, player_name, player_id, skill, skill_type, point, point_phase, point_won_by, serving_team,  reception_quality, attack_phase, evaluation_code, attack_code, skill_subtype, num_players_numeric, phase
  )

df_filtrado <- left_join(df_filtrado, players_info, by = "player_id")




# Contar ataques, recepciones, saques y bloqueos por jugador
players_info <- players_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & skill_type != "other attack") %>%
              group_by(player_id) %>%
              summarise(Ataque_Tot = n(), 
                        Ataque_Punto = sum(evaluation_code == "#"),
                        Ataque_Error = sum(evaluation_code == "="),
                        Ataque_Bloqueado = sum(evaluation_code == "/")),
            by = "player_id") %>%
  left_join(df_filtrado %>% filter(skill == "reception") %>%
              group_by(player_id) %>%
              summarise(Rec_Tot = n(), Rec_Perf = sum(evaluation_code == "#"),
                        Rec_Pos = sum(evaluation_code == "+"),
                        Rec_Exc = sum(evaluation_code == "!"),
                        Rec_Neg = sum(evaluation_code == "-"),
                        Rec_Error = sum(evaluation_code == "="),
                        Rec_Barra = sum(evaluation_code == "/")),
            by = "player_id") %>%
  left_join(df_filtrado %>% filter(skill == "reception" & skill_type == "jump-float serve reception") %>%
              group_by(player_id) %>%
              summarise(Rec_Tot_flot = n(), 
                        Rec_Perf_flot = sum(evaluation_code == "#"),
                        Rec_Pos_flot = sum(evaluation_code == "+"),
                        Rec_Exc_flot = sum(evaluation_code == "!"),
                        Rec_Neg_flot = sum(evaluation_code == "-"),
                        Rec_Error_flot = sum(evaluation_code == "="),
                        Rec_Barra_flot = sum(evaluation_code == "/")),
            by = "player_id") %>%
  left_join(df_filtrado %>% filter(skill == "reception" & skill_type == "jump serve reception") %>%
              group_by(player_id) %>%
              summarise(Rec_Tot_jump = n(), 
                        Rec_Perf_jump = sum(evaluation_code == "#"),
                        Rec_Pos_jump = sum(evaluation_code == "+"),
                        Rec_Exc_jump = sum(evaluation_code == "!"),
                        Rec_Neg_jump = sum(evaluation_code == "-"),
                        Rec_Error_jump = sum(evaluation_code == "="),
                        Rec_Barra_jump = sum(evaluation_code == "/")),
            by = "player_id") %>%
  left_join(df_filtrado %>% filter(skill == "serve") %>%
              group_by(player_id) %>%
              summarise(Saque_Tot = n(),
                        Saque_Punto = sum(evaluation_code == "#"),
                        Saque_Error = sum(evaluation_code == "="),
                        Saque_Pos = sum(evaluation_code == "+"),
                        Saque_Neg = sum(evaluation_code == "-"),
                        Saque_Exc = sum(evaluation_code == "!"),
                        Saque_Barra = sum(evaluation_code == "/")),
            by = "player_id") %>%
  left_join(df_filtrado %>% filter(skill == "serve" & skill_type == "jump-float serve") %>%
              group_by(player_id) %>%
              summarise(Saque_Tot_flot = n(),
                        Saque_Punto_flot = sum(evaluation_code == "#"),
                        Saque_Error_flot = sum(evaluation_code == "="),
                        Saque_Pos_flot = sum(evaluation_code == "+"),
                        Saque_Neg_flot = sum(evaluation_code == "-"),
                        Saque_Exc_flot = sum(evaluation_code == "!"),
                        Saque_Barra_flot = sum(evaluation_code == "/")),
            by = "player_id")  %>%
  left_join(df_filtrado %>% filter(skill == "serve" & skill_type == "jump serve") %>%
              group_by(player_id) %>%
              summarise(Saque_Tot_jump = n(),
                        Saque_Punto_jump = sum(evaluation_code == "#"),
                        Saque_Error_jump = sum(evaluation_code == "="),
                        Saque_Pos_jump = sum(evaluation_code == "+"),
                        Saque_Neg_jump = sum(evaluation_code == "-"),
                        Saque_Exc_jump = sum(evaluation_code == "!"),
                        Saque_Barra_jump = sum(evaluation_code == "/")),
            by = "player_id")  %>%
  left_join(df_filtrado %>% filter(skill == "dig") %>%
              group_by(player_id) %>%
              summarise(Def_Tot = n(),
                        Def_Error = sum(evaluation_code == "="),
                        Def_Error2 = sum(evaluation_code == "/"),
                        Def_Buena = sum(evaluation_code == "#"),
                        Def_Cobert = sum(evaluation_code == "!"),
                        Def_Facil = sum(evaluation_code == "+"),
              ),
            by = "player_id") %>%
  
  left_join(df_filtrado %>% filter(skill == "block") %>%
              group_by(player_id) %>%
              summarise(Bloqueo_Tot = n(),
                        Bloqueo_Punto = sum(evaluation_code == "#")
              ),
            by = "player_id")

```

```{r}
# Obtener estadísticas adicionales por equipo
teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "serve") %>%
              group_by(team) %>%
              summarise(
                Saque_Tot = n(),
                Saque_Punto = sum(evaluation_code == "#"),
                Saque_Error = sum(evaluation_code == "="),
                Saque_Pos = sum(evaluation_code == "+"),
                Saque_Neg = sum(evaluation_code == "-"),
                Saque_Exc = sum(evaluation_code == "!"),
                Saque_Barra = sum(evaluation_code == "/")
              ),
            by = "team")%>%
     mutate(
            `% Error` = round((Saque_Error / Saque_Tot) * 100, 2),
            `% Ace` = round((Saque_Punto / Saque_Tot) * 100, 2),
            Saque_AVG = ifelse(Saque_Tot > 0, round((Saque_Punto * 5 + Saque_Barra * 3 + Saque_Pos * 2 + Saque_Exc * 1  +                           Saque_Neg * -1 + Saque_Error * -2) / Saque_Tot, 2), 0)
    )

```


```{r}
teams_info <- teams_info %>%
  left_join(
    df %>%
      filter(point_won_by == serving_team & team == point_won_by & point_phase =="breakpoint") %>%  # Filtrar puntos ganados por el equipo receptor
      group_by(team) %>%                         
      summarise(BP = n()),                        # Contar nº de breakpoints
    by = "team"
  ) %>%
  mutate(
    Porcentaje_BP = round((BP / Saque_Tot) * 100, 2),
    `% Neg` = round((Saque_Neg / Saque_Tot) * 100, 2),
    `% Error` = round((Saque_Error / Saque_Tot) * 100, 2),
    `% Exclam` = round((Saque_Exc / Saque_Tot) * 100, 2),
    `% Pos` = round((Saque_Pos / Saque_Tot) * 100, 2),
    `% Barra` = round((Saque_Barra / Saque_Tot) * 100, 2),
    `% Ace` = round((Saque_Punto / Saque_Tot) * 100, 2)
  )
```

```{r}

# Calcular el promedio ponderado para cada equipo
teams_info <- teams_info %>%
  mutate(
    `%Exp BP` = round(( (Saque_Punto * 100) + (Saque_Barra * 63.4) + (Saque_Pos * 60.7) + (Saque_Exc * 54.2) + 
                   (Saque_Neg * 33.4) ) / Saque_Tot ,2)
  )
```

```{r}

# Calcular %Diff BP y Exp
teams_info <- teams_info %>%
  mutate(`%Diff BP y Exp` = `%Exp BP` - `Porcentaje_BP` )
```


```{r}
library(gt)

# Crear la tabla con la información de teams_info
tabla_equipos_saque <- teams_info %>%
  arrange(desc(Saque_AVG)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank = Rank,
    Equipo = team,
    Sets = sets_played,
    `Porcentaje BP` = Porcentaje_BP,

    `%Exp BP` = `%Exp BP`,
    `%Diff Exp y BP` = `%Diff BP y Exp`,
    
    Saque = Saque_Tot,
    `Saque AVG` = Saque_AVG,
    Error = Saque_Error,
    `% Error` = `% Error`,
    Neg = Saque_Neg,
    Exclam = Saque_Exc,
    Pos = Saque_Pos,
    Barra = Saque_Barra,
    `% Barra` = `% Barra`,
    Ace = Saque_Punto,
    `% Ace` = `% Ace`,
  ) %>%
  gt() %>%
  cols_label(
    Equipo = 'Equipo',
    Sets = 'Sets',
    `Porcentaje BP` = '% BP',
    Saque = 'Saque',
    `Saque AVG` = 'Saque AVG',
    Error = 'Error',
    `% Error` = '% Error',
    Neg = 'Neg',
    Exclam = 'Exclam',
    Pos = 'Pos',
    Barra = 'Barra',
    `% Barra` = '% Barra',
    Ace = 'Ace',
    `% Ace` = '% Ace'
  ) %>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  ) %>%
  gt::data_color(
    columns = "Porcentaje BP", colors = c("ivory2", "deepskyblue3")
  ) %>%
    gt::data_color(
    columns = "%Exp BP", colors = c("ivory2", "deepskyblue3")
  ) %>%
    gt::data_color(
    columns = "%Diff Exp y BP", colors = c("ivory2", "deepskyblue3")
  ) %>%
  gt::data_color(
    columns = "% Ace", colors = c("ivory2", "palegreen4")
  ) %>%
  gt::data_color(
    columns = "% Barra", colors = c("ivory2", "palegreen4")
  ) %>%
  gt::data_color(
    columns = "% Error", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Saque por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Saque AVG = Valoración media atendiendo a: Saque #: 5, Saque /: 3, Saque +: 2, Saque !: 1, Saque -: -1,  Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  ) %>%
  tab_footnote(
    footnote = "Ranking mejores equipos en saque atendiendo a Saque AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
    tab_footnote(
    footnote = "%Exp BP (% Expected breakpoint): Saque #: 1.00, Saque /: 0.634, Saque +: 0.607, Saque !: 0.542, Saque -:     0.334, Saque =: 0.00",
    locations = cells_column_labels(columns = `%Exp BP`)
  ) %>%
    tab_footnote(
    footnote = "%Diff Exp y BP: Diferencia entre Expected BP y BP real",
    locations = cells_column_labels(columns = `%Diff Exp y BP`)
  ) %>%
  tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  
  text_transform(
    locations = cells_body(vars(Equipo)), 
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )  

# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_saque, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_saque.html")


```




```{r}
library(ggplot2)

asp_ratio <- 1.618
# Crear el gráfico
grafico_ace_vs_error <- ggplot(teams_info, aes(x = `% Ace`, y = `% Error`, label = team, fill = team)) +
  scale_x_continuous(limits = c(2, 8), 
                     breaks = seq(2, 8, 1), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(14, 18), 
                     breaks = seq(14, 18, 0.5), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% Ace",
       y = "% Error",
       title = expression(paste(bold("SAQUE %Ace vs %Error"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `% Ace`, y = `% Error`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)

# Mostrar el gráfico
print(grafico_ace_vs_error)

# Guardar la tabla como un archivo HTML
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/ace vs error.png", plot = grafico_ace_vs_error, width = 8, height = 6, units = "in", dpi = 300)

```

```{r}
# Calcular Saque_AVG para cada jugador
players_info <- players_info %>%
  mutate(
    Saque_AVG = ifelse(Saque_Tot > 0, round((Saque_Punto * 5 + Saque_Barra * 3 + Saque_Pos * 2 + Saque_Exc * 1 + Saque_Neg * -1 + Saque_Error * -2) / Saque_Tot, 2), 0),
    
  )

top_sacadores <- players_info %>%
 mutate(
    `% Neg` = round((Saque_Neg / Saque_Tot) * 100, 2),
    `% Error` = round((Saque_Error / Saque_Tot) * 100, 2),
    `% Exclam` = round((Saque_Exc / Saque_Tot) * 100, 2),
    `% Pos` = round((Saque_Pos / Saque_Tot) * 100, 2),
    `% Barra` = round((Saque_Barra / Saque_Tot) * 100, 2),
    `% Ace` = round((Saque_Punto / Saque_Tot) * 100, 2)
  )


# Obtener los top 10 jugadores con mejor Saque_AVG
top_sacadores <- top_sacadores %>%
     filter(Saque_Tot >= 50)%>%
  arrange(desc(Saque_AVG)) %>%
  head(15)
```


```{r}
tabla_top_sacadores <- top_sacadores %>%
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Jugador = player_name,
     Sets = sets_played,
    `Nº Saque` = Saque_Tot,
    
    `Saque AVG` = Saque_AVG,
    Ace = Saque_Punto,
    `% Ace` = `% Ace`,
    
    Barra = Saque_Barra,
    `% Barra` = `% Barra`,
    
    Pos = Saque_Pos,
    Exclam = Saque_Exc,
    Neg = Saque_Neg,
    Error = Saque_Error,
     `% Error` = `% Error`
    
    
  ) %>%
  gt() %>%
  cols_label(
    Rank = 'Rank',
    Jugador = 'Jugador',
    `Saque AVG` = 'Saque AVG',
    Ace = 'Ace',
    Error = 'Error',
    Neg = 'Neg',
    Exclam = 'Exclam',
    Pos = 'Pos',
    Barra = 'Barra'
  ) %>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Ace", colors = c("ivory2", "palegreen4")
  )%>%
    gt::data_color(
    columns = "% Barra", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Error", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Top 15 Sacadores',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Saque AVG = Valoración media atendiendo a: Saque #: 5, Saque /: 3, Saque +: 2, Saque !: 1, Saque -: -1,  Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  ) %>%
  tab_footnote(
    footnote = "Mínimo de saques: 50",
    locations = cells_title(groups = "title")
  )%>%
    tab_footnote(
    footnote = "Ranking mejores sacadores atendiendo a Saque AVG",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
    tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_top_sacadores, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_saque.html")
```




//SAQUE FLOT



```{r}
# Obtener estadísticas adicionales por equipo
teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "serve" & skill_type == "jump-float serve") %>%
              group_by(team) %>%
              summarise(
                Saque_Tot_flot = n(),
                Saque_Punto_flot = sum(evaluation_code == "#"),
                Saque_Error_flot = sum(evaluation_code == "="),
                Saque_Pos_flot = sum(evaluation_code == "+"),
                Saque_Neg_flot = sum(evaluation_code == "-"),
                Saque_Exc_flot = sum(evaluation_code == "!"),
                Saque_Barra_flot = sum(evaluation_code == "/")
              ),
            by = "team")%>%
     mutate(
            `% Saque Error_flot` = round((Saque_Error_flot / Saque_Tot) * 100, 2),
            `% Saque ACE_flot` = round((Saque_Punto_flot / Saque_Tot) * 100, 2),
            `% Saque Neg_flot` = round((Saque_Neg_flot / Saque_Tot_flot) * 100, 2),
            `% Saque Error_flot` = round((Saque_Error_flot / Saque_Tot_flot) * 100, 2),
            `% Saque Exclam_flot` = round((Saque_Exc_flot / Saque_Tot_flot) * 100, 2),
            `% Saque Pos_flot` = round((Saque_Pos_flot / Saque_Tot_flot) * 100, 2),
            `% Saque Barra_flot` = round((Saque_Barra_flot / Saque_Tot_flot) * 100, 2),
            Saque_AVG_flot = ifelse(Saque_Tot_flot > 0, round((Saque_Punto_flot * 5 + Saque_Barra_flot * 3 + Saque_Pos_flot *                           2 + Saque_Exc_flot * 1  + Saque_Neg_flot * -1 + Saque_Error_flot * -2) / Saque_Tot_flot, 2), 0)
  )

```


```{r}
bp_flot <- df %>%
  filter(point_won_by == serving_team & team == point_won_by & skill_type == "jump-float serve") %>%
  group_by(team) %>%                         
  summarise(BP_flot = n())                        # Contar nº de breakpoints
```


```{r}
teams_info <- teams_info %>%
  left_join(
    bp_flot,
    by = "team"
  ) %>%
  mutate(
    Porcentaje_BP_flot = round((BP_flot / Saque_Tot_flot) * 100, 2)
  )
```


```{r}

# Calcular el promedio ponderado para cada equipo
teams_info <- teams_info %>%
  mutate(
    `%Exp BP_flot` = round(( (Saque_Punto_flot * 100) + (Saque_Barra_flot * 63.4) + (Saque_Pos_flot * 60.7) + (Saque_Exc_flot * 54.2) + 
                   (Saque_Neg_flot * 33.4) ) / Saque_Tot_flot ,2)
  )
```

```{r}

# Calcular %Diff BP y Exp
teams_info <- teams_info %>%
  mutate(`%Diff BP y Exp_flot` = `%Exp BP_flot` - `Porcentaje_BP_flot` )
```


```{r}
library(gt)

# Crear la tabla con la información de teams_info
tabla_equipos_saque_flot <- teams_info  %>%
  arrange(desc(Saque_AVG_flot)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank = Rank,
    Equipo = team,
    Sets = sets_played,
    `Porcentaje BP` = Porcentaje_BP_flot,
    `%Exp BP` = `%Exp BP_flot`,
    `%Diff Exp y BP` = `%Diff BP y Exp_flot`,
    
    Saque = Saque_Tot_flot,
    `Saque AVG` = Saque_AVG_flot,
    Ace = Saque_Punto_flot,
    `% Ace` = `% Saque ACE_flot`,
    
    Barra = Saque_Barra_flot,
    `% Barra` = `% Saque Barra_flot`,
    
    Pos = Saque_Pos_flot,
     Exclam = Saque_Exc_flot,
    Neg = Saque_Neg_flot,
    Error = Saque_Error_flot,
    `% Error` = `% Saque Error_flot`
    
  ) %>%
  gt() %>%
  cols_label(
    Equipo = 'Equipo',
    Sets = 'Sets',
    `Porcentaje BP` = '% BP',
    Saque = 'Saque',
    `Saque AVG` = 'Saque AVG',
    Error = 'Error',
    `% Error` = '% Error',
    Neg = 'Neg',
    Exclam = 'Exclam',
    Pos = 'Pos',
    Barra = 'Barra',
    Ace = 'Ace',
     `% Ace` = '% Ace'
  ) %>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "Porcentaje BP", colors = c("ivory2", "deepskyblue3")
  ) %>%
    gt::data_color(
    columns = "%Exp BP", colors = c("ivory2", "deepskyblue3")
  ) %>%
    gt::data_color(
    columns = "%Diff Exp y BP", colors = c("ivory2", "deepskyblue3")
  ) %>%
  gt::data_color(
    columns = "% Ace", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Barra", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Error", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Saque FLOT por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Saque AVG = Valoración media atendiendo a: Saque #: 5, Saque /: 3, Saque +: 2, Saque !: 1, Saque -: -1,  Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  ) %>%
  tab_footnote(
    footnote = "Ranking mejores equipos en SAQUE FLOTANTE atendiendo a Saque AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
    tab_footnote(
    footnote = "%Exp BP (% Expected breakpoint): Saque #: 1.00, Saque /: 0.634, Saque +: 0.607, Saque !: 0.542, Saque -: 0.334, Saque =: 0.00",
    locations = cells_column_labels(columns = `%Exp BP`)
  ) %>%
    tab_footnote(
    footnote = "%Diff Exp y BP: Diferencia entre Expected BP y BP real",
    locations = cells_column_labels(columns = `%Diff Exp y BP`)
  ) %>%
  tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  
  text_transform(
    locations = cells_body(vars(Equipo)),  # Aplicar la transformación solo a la columna "Equipo"
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )


# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_saque_flot, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_saque_flot.html")


```

```{r}
grafico_ace_vs_error_flot <- ggplot(teams_info, aes(x = Saque_Tot_flot, y = `%Exp BP_flot`, label = team, fill = team)) +
  scale_x_continuous(limits = c(0, 950), 
                     breaks = seq(0, 950, 50), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(34, 44), 
                     breaks = seq(34, 44, 2), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = -0.1, nudge_x = c(0.1, -0.1)) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº saques",
       y = "%Expected BP",
       title = expression(paste(bold("Saque flot: %Expected Breakpoint"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = Saque_Tot_flot, y = `%Exp BP_flot`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)

# Mostrar el gráfico
print(grafico_ace_vs_error_flot)

# Guardar la tabla como un archivo HTML
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/Exp BP (saque flot).png", plot = grafico_ace_vs_error_flot, width = 8, height = 6, units = "in", dpi = 300)

```


```{r}
# Calcular Saque_AVG para cada jugador
players_info <- players_info %>%
  mutate(
    Saque_AVG_flot = ifelse(Saque_Tot_flot > 0, round((Saque_Punto_flot * 5 + Saque_Barra_flot * 3 + Saque_Pos_flot * 2 + Saque_Exc_flot * 1 + Saque_Neg_flot * -1 + Saque_Error_flot * -2) / Saque_Tot_flot, 2), 0),
    
  )

top_sacadores_flot <- players_info %>%
 mutate(
    `% Neg_flot` = round((Saque_Neg_flot / Saque_Tot_flot) * 100, 2),
    `% Error_flot` = round((Saque_Error_flot / Saque_Tot_flot) * 100, 2),
    `% Exclam_flot` = round((Saque_Exc_flot / Saque_Tot_flot) * 100, 2),
    `% Pos_flot` = round((Saque_Pos_flot / Saque_Tot_flot) * 100, 2),
    `% Barra_flot` = round((Saque_Barra_flot / Saque_Tot_flot) * 100, 2),
    `% ACE_flot` = round((Saque_Punto_flot / Saque_Tot_flot) * 100, 2)
  )


# Obtener los top 10 jugadores con mejor Saque_AVG
top_sacadores_flot <- top_sacadores_flot %>%
     filter(Saque_Tot_flot >= 50)%>%
  arrange(desc(Saque_AVG_flot)) %>%
  head(15)
```


```{r}
tabla_top_sacadores_flot <- top_sacadores_flot %>%
  arrange(desc(Saque_AVG_flot))%>%
  mutate(Rank = row_number())%>%
  select(
    Rank,
    Jugador = player_name,
     Sets = sets_played,
    `Nº Saque` = Saque_Tot_flot,
    `Saque AVG` = Saque_AVG_flot,
    Ace = Saque_Punto_flot,
    `% Ace` = `% ACE_flot`,
    Barra = Saque_Barra_flot,
    `% Barra` = `% Barra_flot`,
    Pos = Saque_Pos_flot,
    Exclam = Saque_Exc_flot,
    Neg = Saque_Neg_flot,
    Error = Saque_Error_flot,
     `% Error` = `% Error_flot`
    
  ) %>%
  gt() %>%
  cols_label(
    Jugador = 'Jugador',
    `Saque AVG` = 'Saque AVG',
    Ace = 'Ace',
    Error = 'Error',
    Neg = 'Neg',
    Exclam = 'Exclam',
    Pos = 'Pos',
    Barra = 'Barra'
  ) %>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Ace", colors = c("ivory2", "palegreen4")
  )%>%
    gt::data_color(
    columns = "% Barra", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Error", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Top 15 jugadores saque FLOT',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Saque AVG = Valoración media atendiendo a: Saque #: 5, Saque /: 3, Saque +: 2, Saque !: 1, Saque -: -1,  Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  ) %>%
  tab_footnote(
    footnote = "Mínimo de saques: 50",
    locations = cells_title(groups = "title")
  )%>%
  tab_footnote(
    footnote = "Ranking mejores jugadores SAQUE FLOTANTE atendiendo a Saque AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_top_sacadores_flot, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_saque_flot.html")
```


//SAQUE SALTO



```{r}
# Obtener estadísticas adicionales por equipo
teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "serve" & skill_type == "jump serve") %>%
              group_by(team) %>%
              summarise(
                Saque_Tot_jump = n(),
                Saque_Punto_jump = sum(evaluation_code == "#"),
                Saque_Error_jump = sum(evaluation_code == "="),
                Saque_Pos_jump = sum(evaluation_code == "+"),
                Saque_Neg_jump = sum(evaluation_code == "-"),
                Saque_Exc_jump = sum(evaluation_code == "!"),
                Saque_Barra_jump = sum(evaluation_code == "/")
              ),
            by = "team")%>%
     mutate(
            `% Saque Error_jump` = round((Saque_Error_jump / Saque_Tot) * 100, 2),
            `% Saque ACE_jump` = round((Saque_Punto_jump / Saque_Tot) * 100, 2),
            Saque_AVG_jump = ifelse(Saque_Tot_jump > 0, round((Saque_Punto_jump * 5 + Saque_Barra_jump * 3 + Saque_Pos_jump *                     2 + Saque_Exc_jump * 1  + Saque_Neg_jump * -1 + Saque_Error_jump * -2) / Saque_Tot_jump, 2), 0)
  )

```


```{r}
bp_jump <- df %>%
  filter(point_won_by == serving_team & team == point_won_by & skill_type == "jump serve") %>%
  group_by(team) %>%                         
  summarise(BP_jump = n())                        # Contar nº de breakpoints
```


```{r}
teams_info <- teams_info %>%
  left_join(
    bp_jump,
    by = "team"
  ) %>%
  mutate(
    Porcentaje_BP_jump = round((BP_jump / Saque_Tot_jump) * 100, 2),
    `% Saque Neg_jump` = round((Saque_Neg_jump / Saque_Tot_jump) * 100, 2),
    `% Saque Error_jump` = round((Saque_Error_jump / Saque_Tot_jump) * 100, 2),
    `% Saque Exclam_jump` = round((Saque_Exc_jump / Saque_Tot_jump) * 100, 2),
    `% Saque Pos_jump` = round((Saque_Pos_jump / Saque_Tot_jump) * 100, 2),
    `% Saque Barra_jump` = round((Saque_Barra_jump / Saque_Tot_jump) * 100, 2),
    `% Saque ACE_jump` = round((Saque_Punto_jump / Saque_Tot_jump) * 100, 2)
    
  )
```


```{r}

# Calcular el promedio ponderado para cada equipo
teams_info <- teams_info %>%
  mutate(
    `%Exp BP_jump` = round(( (Saque_Punto_jump * 100) + (Saque_Barra_jump * 63.4) + (Saque_Pos_jump * 60.7) + (Saque_Exc_jump * 54.2) + 
                   (Saque_Neg_jump * 33.4) ) / Saque_Tot_jump ,2)
  )
```

```{r}

# Calcular %Diff BP y Exp
teams_info <- teams_info %>%
  mutate(`%Diff BP y Exp_jump` = `%Exp BP_jump` - `Porcentaje_BP_jump` )
```


```{r}
library(gt)

# Crear la tabla con la información de teams_info
tabla_equipos_saque_jump <- teams_info  %>%
  arrange(desc(Saque_AVG_jump)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Porcentaje BP` = Porcentaje_BP_jump,
    
    `%Exp BP` = `%Exp BP_jump`,
    `%Diff Exp y BP` = `%Diff BP y Exp_jump`,
    
    Saque = Saque_Tot_jump,
    `Saque AVG` = Saque_AVG_jump,
     Ace = Saque_Punto_jump,
    `% Ace` = `% Saque ACE_jump`,
    Barra = Saque_Barra_jump,
    `% Barra` = `% Saque Barra_jump`,
    Pos = Saque_Pos_jump,
    Exclam = Saque_Exc_jump,
    Neg = Saque_Neg_jump,
    Error = Saque_Error_jump,
    `% Error` = `% Saque Error_jump`,
   
  ) %>%
  gt() %>%
  cols_label(
    Equipo = 'Equipo',
    Sets = 'Sets',
    `Porcentaje BP` = '% BP',
    Saque = 'Saque',
    `Saque AVG` = 'Saque AVG',
    Error = 'Error',
    `% Error` = '% Error',
    Neg = 'Neg',
    Exclam = 'Exclam',
    Pos = 'Pos',
    Barra = 'Barra',
    Ace = 'Ace',
     `% Ace` = '% Ace'
  ) %>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "Porcentaje BP", colors = c("ivory2", "deepskyblue3")
  ) %>%
  gt::data_color(
    columns = "%Exp BP", colors = c("ivory2", "deepskyblue3")
  ) %>%
  gt::data_color(
    columns = "%Diff Exp y BP", colors = c("ivory2", "deepskyblue3")
  ) %>%
  gt::data_color(
    columns = "% Ace", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Barra", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Error", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Saque POTENCIA por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Saque AVG = Valoración media atendiendo a: Saque #: 5, Saque /: 3, Saque +: 2, Saque !: 1, Saque -: -1,  Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  ) %>%
  tab_footnote(
    footnote = "Ranking mejores equipos en SAQUE POTENCIA atendiendo a Saque AVG",
    locations = cells_column_labels(columns = `Rank`)
  )%>%
      tab_footnote(
    footnote = "%Exp BP (% Expected breakpoint): Saque #: 1.00, Saque /: 0.634, Saque +: 0.607, Saque !: 0.542, Saque -: 0.334, Saque =: 0.00",
    locations = cells_column_labels(columns = `%Exp BP`)
  ) %>%
    tab_footnote(
    footnote = "%Diff Exp y BP: Diferencia entre Expected BP y BP real",
    locations = cells_column_labels(columns = `%Diff Exp y BP`)
  ) %>%
  tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  
  text_transform(
    locations = cells_body(vars(Equipo)),  # Aplicar la transformación solo a la columna "Equipo"
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )


# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_saque_jump, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_saque_jump.html")


```


```{r}
grafico_ace_vs_error_jump <- ggplot(teams_info, aes(x = `% Saque ACE_jump`, y = `% Saque Error_jump`, label = team, fill = team)) +
  scale_x_continuous(limits = c(0, 12), 
                     breaks = seq(0, 12, 1), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(15, 25), 
                     breaks = seq(15, 25, 1), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% Ace",
       y = "% Error",
       title = expression(paste(bold("SAQUE POTENCIA %Ace vs %Error"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `% Saque ACE_jump`, y = `% Saque Error_jump`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)

# Mostrar el gráfico
print(grafico_ace_vs_error_jump)

# Guardar la tabla como un archivo HTML
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/ace vs error_jump.png", plot = grafico_ace_vs_error_jump, width = 8, height = 6, units = "in", dpi = 300)

```



```{r}
# Calcular Saque_AVG para cada jugador
players_info <- players_info %>%
  mutate(
    Saque_AVG_jump = ifelse(Saque_Tot_jump > 0, round((Saque_Punto_jump * 5 + Saque_Barra_jump * 3 + Saque_Pos_jump * 2 + Saque_Exc_jump * 1 + Saque_Neg_jump * -1 + Saque_Error_jump * -2) / Saque_Tot_jump, 2), 0),
    
  )

top_sacadores_jump <- players_info %>%
 mutate(
    `% Neg_jump` = round((Saque_Neg_jump / Saque_Tot_jump) * 100, 2),
    `% Error_jump` = round((Saque_Error_jump / Saque_Tot_jump) * 100, 2),
    `% Exclam_jump` = round((Saque_Exc_jump / Saque_Tot_jump) * 100, 2),
    `% Pos_jump` = round((Saque_Pos_jump / Saque_Tot_jump) * 100, 2),
    `% Barra_jump` = round((Saque_Barra_jump / Saque_Tot_jump) * 100, 2),
    `% ACE_jump` = round((Saque_Punto_jump / Saque_Tot_jump) * 100, 2)
  )


# Obtener los top 10 jugadores con mejor Saque_AVG
top_sacadores_jump <- top_sacadores_jump %>%
     filter(Saque_Tot_jump >= 50)%>%
  arrange(desc(Saque_AVG_jump)) %>%
  head(15)
```


```{r}
tabla_top_sacadores_jump <- top_sacadores_jump %>%
  arrange(desc(Saque_AVG_jump))%>%
  mutate(Rank = row_number())%>%
  select(
    Rank,
    Jugador = player_name,
     Sets = sets_played,
    `Nº Saque` = Saque_Tot_jump,
    `Saque AVG` = Saque_AVG_jump,
    Ace = Saque_Punto_jump,
    `% Ace` = `% ACE_jump`,
    Barra = Saque_Barra_jump,
    `% Barra` = `% Barra_jump`,
    Pos = Saque_Pos_jump,
    Exclam = Saque_Exc_jump,
    Neg = Saque_Neg_jump,
    Error = Saque_Error_jump,
     `% Error` = `% Error_jump`
    
  ) %>%
  gt() %>%
  cols_label(
    Jugador = 'Jugador',
    `Saque AVG` = 'Saque AVG',
    Ace = 'Ace',
    Error = 'Error',
    Neg = 'Neg',
    Exclam = 'Exclam',
    Pos = 'Pos',
    Barra = 'Barra'
  ) %>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Ace", colors = c("ivory2", "palegreen4")
  )%>%
    gt::data_color(
    columns = "% Barra", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Error", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Top 15 jugadores saque POTENCIA',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Saque AVG = Valoración media atendiendo a: Saque #: 5, Saque /: 3, Saque +: 2, Saque !: 1, Saque -: -1,  Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  ) %>%
  tab_footnote(
    footnote = "Ranking mejores jugadores SAQUE POTENCIA atendiendo a Saque AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_top_sacadores_jump, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_saque_jump.html")
```



//////// RECEPCION



```{r}
# Obtener estadísticas adicionales por equipo
teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "reception") %>%
              group_by(team) %>%
              summarise(
                Rec_Tot = n(),
                Rec_Perf = sum(evaluation_code == "#"),
                Rec_Pos = sum(evaluation_code == "+"),
                Rec_Exc = sum(evaluation_code == "!"),
                Rec_Neg = sum(evaluation_code == "-"),
                Rec_Barra = sum(evaluation_code == "/"),
                Rec_Error = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Rec Perf` = round((Rec_Perf / Rec_Tot) * 100, 2),
            `% Rec Pos` = round((Rec_Pos / Rec_Tot) * 100, 2),
            `% Rec Exc` = round((Rec_Exc / Rec_Tot) * 100, 2),
            `% Rec Neg` = round((Rec_Neg / Rec_Tot) * 100, 2),
            `% Rec Barra` = round((Rec_Barra / Rec_Tot) * 100, 2),
            `% Rec Error` = round((Rec_Error / Rec_Tot) * 100, 2),
            `% Rec Eficacia` = ifelse(Rec_Tot > 0, round((Rec_Perf + Rec_Pos) / Rec_Tot * 100, 2), 0),
            `% Rec Eficiencia` = ifelse(Rec_Tot > 0, round((Rec_Perf + Rec_Pos - (Rec_Error + Rec_Barra)) / Rec_Tot, 2), 0),
            Rec_AVG = ifelse(Rec_Tot > 0, round((Rec_Perf * 5 + Rec_Pos * 3 + Rec_Exc * 2 + Rec_Neg * 1  + Rec_Barra *                          -1 + Rec_Error * -2) / Rec_Tot, 2), 0),
    )

```


```{r}
sideout <- df %>%
  filter(point_won_by != serving_team & team == point_won_by) %>%
  filter(skill == "reception")%>%
  group_by(team) %>%                         
  summarise(SO = n())                        # Contar nº sideouts
```


```{r}
teams_info <- teams_info %>%
  left_join(
    sideout,
    by = "team"
  ) %>%
  mutate(
    Porcentaje_SO = round((SO / Rec_Tot) * 100, 2)
  )
```


```{r}

# Calcular el promedio ponderado para cada equipo
teams_info <- teams_info %>%
  mutate(
    `%Exp SO` = round(( (Rec_Perf * 63.9) + (Rec_Pos * 62.9) + (Rec_Exc * 60.7) + (Rec_Neg * 54.2) + 
                   (Rec_Barra * 33.4) + (Rec_Error * 0.0) ) / Rec_Tot ,2)
  )
```

```{r}

# Calcular %Diff BP y Exp
teams_info <- teams_info %>%
  mutate(`%Diff SO y Exp` = `Porcentaje_SO` - `%Exp SO` )
```



```{r}
library(gt)

# Crear la tabla con la información de teams_info
tabla_equipos_rece <- teams_info  %>%
  arrange(desc(Rec_AVG)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `% SO` = Porcentaje_SO,
    `%Exp SO` = `%Exp SO`,
    `%Diff SO y Exp` = `%Diff SO y Exp`,
    
    `Nº Rec` = Rec_Tot,
    `Rec AVG` = Rec_AVG,
    
    `% Rec Eficiencia` = `% Rec Eficiencia`,
    `% Rec Eficacia` = `% Rec Eficacia`,
    
    `Rec Perf` = Rec_Perf,
    `% Rec #` = `% Rec Perf`,
    
    `Rec Pos` = Rec_Pos,
    `% Rec +` = `% Rec Pos`,
    `Rec Exc` = Rec_Exc,
    `Rec Neg` = Rec_Neg,
    
    `Rec Barra` = Rec_Barra,
    `% Rec /` = `% Rec Barra`,
    `Rec Error` = Rec_Error,
    `% Rec =` = `% Rec Error`,
    
  ) %>%
  gt() %>%
  gt::data_color(
    columns = "Rec AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% SO", colors = c("ivory2", "deepskyblue3")
  )%>%
  gt::data_color(
    columns = "%Exp SO", colors = c("ivory2", "deepskyblue3")
  )%>%
  gt::data_color(
    columns = "%Diff SO y Exp", colors = c("ivory2", "deepskyblue3")
  )%>%
  gt::data_color(
    columns = "% Rec Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec +", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec #", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec /", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% Rec =", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Recepción por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Rec AVG = Valoración media atendiendo a: Rec #: 5, Rec +: 3, Rec !: 2, Rec -: 1, Rec /: -1,  Rec =: -2",
    locations = cells_column_labels(columns = `Rec AVG`)
  ) %>%
  tab_footnote(
    footnote = "Ranking mejores equipos en recepción atendiendo a Rec AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
  tab_footnote(
    footnote = "%Exp SO (%Expected Sideout): Rec #: 0.639, Rec +: 0.634, Rec !: 0.607, Rec -: 0.542, Rec /: 0.334, Rec =: 0.00",
    locations = cells_column_labels(columns = `%Exp SO`)
  ) %>%
  tab_footnote(
    footnote = "%Diff SO y Exp: Diferencia entre SO real y Exp SO",
    locations = cells_column_labels(columns = `%Diff SO y Exp`)
  ) %>%
  tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)), 
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )


# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_rece, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_rece.html")

```

```{r}
# Crear el gráfico con ajustes en los ejes
grafico_rec_avg_vs_so <- ggplot(teams_info, aes(x = `Porcentaje_SO`, y = Rec_AVG, label = team, fill = team)) +
  scale_x_continuous(limits = c(52, 66), 
                     breaks = seq(52, 66, 2), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(2, 2.5), 
                     breaks = seq(2, 2.5, 0.1), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% SO",
       y = "Recepción AVG",
       title = expression(paste(bold("%SO vs Recepción AVG"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Porcentaje_SO`, y = `Rec_AVG`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)

# Mostrar el gráfico
print(grafico_rec_avg_vs_so)

# Guardar la tabla como un archivo PNG
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/rec_vs_so.png", plot = grafico_rec_avg_vs_so, width = 8, height = 6, units = "in", dpi = 300)


```


```{r}
# Calcular Saque_AVG para cada jugador
players_info <- players_info %>%
  mutate(
    Rec_AVG = ifelse(Rec_Tot > 0, round((Rec_Perf * 5 + Rec_Pos * 3 + Rec_Exc * 2 + Rec_Neg * 1 + Rec_Barra * -1 + Rec_Error * -2) / Rec_Tot, 2), 0),
    
  )

top_receptores <- players_info %>%
 mutate(
    `% Rec Error` = round((Rec_Error / Rec_Tot) * 100, 2),
    `% Rec Barra` = round((Rec_Barra / Rec_Tot) * 100, 2),
    `% Rec Neg` = round((Rec_Neg / Rec_Tot) * 100, 2),
    `% Rec Exc` = round((Rec_Exc / Rec_Tot) * 100, 2),
    `% Rec Pos` = round((Rec_Pos / Rec_Tot) * 100, 2),
    `% Rec Perf` = round((Rec_Perf / Rec_Tot) * 100, 2),
    `% Rec Eficacia` = ifelse(Rec_Tot > 0, round((Rec_Perf + Rec_Pos) / Rec_Tot * 100, 2), 0),
    `% Rec Eficiencia` = ifelse(Rec_Tot > 0, round((Rec_Perf + Rec_Pos - (Rec_Error + Rec_Barra)) / Rec_Tot, 2), 0)
  )


# Obtener los top 15 jugadores con mejor Saque_AVG
top_receptores <- top_receptores %>%
     filter(Rec_Tot >= 50)%>%
  arrange(desc(`Rec_AVG`)) %>%
  head(15)
```


```{r}
# Crear la tabla con los 10 mejores receptores
tabla_top_receptores <- top_receptores %>%
  arrange(desc(Rec_AVG))%>%
  mutate(Rank = row_number())%>%
  select(
    Rank,
    Jugador = player_name,
    Sets = sets_played,
    Posicion = player_rol,
    `Nº Rec` = Rec_Tot,
    `Rec AVG` = Rec_AVG,
    `% Rec Eficiencia` = `% Rec Eficiencia`,
    `% Rec Eficacia` = `% Rec Eficacia`,
    `% Rec #` = `% Rec Perf`,
    `% Rec +` = `% Rec Pos`,
    `% Rec !` = `% Rec Exc`,
    `% Rec -` = `% Rec Neg`,
    `% Rec /` = `% Rec Barra`,
    `% Rec =` = `% Rec Error`,
  ) %>%
  gt() %>%
  gt::data_color(
    columns = "Rec AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec +", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec #", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec /", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% Rec =", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Top 15 jugadores recepción',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Rec AVG = Valoración media atendiendo a: Rec #: 5, Rec +: 3, Rec !: 2, Rec -: 1, Rec /: -1,  Rec =: -2",
    locations = cells_column_labels(columns = `Rec AVG`)
  ) %>%
  tab_footnote(
    footnote = "Mínimo de recepciones: 50",
    locations = cells_title(groups = "title")
  )%>%
  tab_footnote(
    footnote = "Ranking mejores jugadores en RECEPCIÓN atendiendo a Rec AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_top_receptores, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_rece.html")

```



//////// RECEPCION FLOT



```{r}
# Obtener estadísticas adicionales por equipo
teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "reception" & skill_type == "jump-float serve reception") %>%
              group_by(team) %>%
              summarise(
                Rec_Tot_flot = n(),
                Rec_Perf_flot = sum(evaluation_code == "#"),
                Rec_Pos_flot = sum(evaluation_code == "+"),
                Rec_Exc_flot = sum(evaluation_code == "!"),
                Rec_Neg_flot = sum(evaluation_code == "-"),
                Rec_Barra_flot = sum(evaluation_code == "/"),
                Rec_Error_flot = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Rec Perf_flot` = round((Rec_Perf_flot / Rec_Tot_flot) * 100, 2),
            `% Rec Pos_flot` = round((Rec_Pos_flot / Rec_Tot_flot) * 100, 2),
            `% Rec Exc_flot` = round((Rec_Exc_flot / Rec_Tot_flot) * 100, 2),
            `% Rec Neg_flot` = round((Rec_Neg_flot / Rec_Tot_flot) * 100, 2),
            `% Rec Barra_flot` = round((Rec_Barra_flot / Rec_Tot_flot) * 100, 2),
            `% Rec Error_flot` = round((Rec_Error_flot / Rec_Tot_flot) * 100, 2),
            `% Rec Eficacia_flot` = ifelse(Rec_Tot_flot > 0, round((Rec_Perf_flot + Rec_Pos_flot) / Rec_Tot_flot * 100, 2), 0),
            `% Rec Eficiencia_flot` = ifelse(Rec_Tot_flot > 0, round((Rec_Perf_flot + Rec_Pos_flot - (Rec_Error_flot + Rec_Barra_flot)) / Rec_Tot_flot, 2), 0),
            Rec_AVG_flot = ifelse(Rec_Tot_flot > 0, round((Rec_Perf_flot * 5 + Rec_Pos_flot * 3 + Rec_Exc_flot * 2 + Rec_Neg_flot * 1  + Rec_Barra_flot *                          -1 + Rec_Error_flot * -2) / Rec_Tot_flot, 2), 0),
    )

```


```{r}
sideout_flot <- df %>%
  filter(point_won_by != serving_team & team == point_won_by) %>%
  filter(skill == "reception" & skill_type == "jump-float serve reception")%>%
  group_by(team) %>%                         
  summarise(SO_flot = n())                        # Contar nº sideouts
```


```{r}
teams_info <- teams_info %>%
  left_join(
    sideout_flot,
    by = "team"
  ) %>%
  mutate(
    Porcentaje_SO_flot = round((SO_flot / Rec_Tot_flot) * 100, 2)
  )
```


```{r}

# Calcular el promedio ponderado para cada equipo
teams_info <- teams_info %>%
  mutate(
    `%Exp SO_flot` = round(( (Rec_Perf_flot * 63.9) + (Rec_Pos_flot * 62.9) + (Rec_Exc_flot * 60.7) + (Rec_Neg_flot * 54.2) + 
                   (Rec_Barra_flot * 33.4) + (Rec_Error_flot * 0.0) ) / Rec_Tot_flot ,2)
  )
```

```{r}

# Calcular %Diff BP y Exp
teams_info <- teams_info %>%
  mutate(`%Diff SO y Exp_flot` = `Porcentaje_SO_flot` - `%Exp SO_flot` )
```



```{r}
library(gt)

# Crear la tabla con la información de teams_info
tabla_equipos_rece_flot <- teams_info  %>%
  arrange(desc(Rec_AVG_flot)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `% SO` = Porcentaje_SO_flot,
    `%Exp SO` = `%Exp SO_flot`,
    `%Diff SO y Exp` = `%Diff SO y Exp_flot`,
    
    `Nº Rec` = Rec_Tot_flot,
    `Rec AVG` = Rec_AVG_flot,
    
    `% Rec Eficiencia` = `% Rec Eficiencia_flot`,
    `% Rec Eficacia` = `% Rec Eficacia_flot`,
    
    `Rec Perf` = Rec_Perf_flot,
    `% Rec #` = `% Rec Perf_flot`,
    
    `Rec Pos` = Rec_Pos_flot,
    `% Rec +` = `% Rec Pos_flot`,
    `Rec Exc` = Rec_Exc_flot,
    `Rec Neg` = Rec_Neg_flot,
    
    `Rec Barra` = Rec_Barra_flot,
    `% Rec /` = `% Rec Barra_flot`,
    `Rec Error` = Rec_Error_flot,
    `% Rec =` = `% Rec Error_flot`,
    
  ) %>%
  gt() %>%
  gt::data_color(
    columns = "Rec AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% SO", colors = c("ivory2", "deepskyblue3")
  )%>%
  gt::data_color(
    columns = "%Exp SO", colors = c("ivory2", "deepskyblue3")
  )%>%
  gt::data_color(
    columns = "%Diff SO y Exp", colors = c("ivory2", "deepskyblue3")
  )%>%
  gt::data_color(
    columns = "% Rec Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec +", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec #", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec /", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% Rec =", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Recepción FLOT por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Rec AVG = Valoración media atendiendo a: Rec #: 5, Rec +: 3, Rec !: 2, Rec -: 1, Rec /: -1,  Rec =: -2",
    locations = cells_column_labels(columns = `Rec AVG`)
  ) %>%
  tab_footnote(
    footnote = "Ranking mejores equipos en recepción FLOT atendiendo a Rec AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
    tab_footnote(
    footnote = "%Exp SO (%Expected Sideout): Rec #: 0.639, Rec +: 0.634, Rec !: 0.607, Rec -: 0.542, Rec /: 0.334, Rec =: 0.00",
    locations = cells_column_labels(columns = `%Exp SO`)
  ) %>%
  tab_footnote(
    footnote = "%Diff SO y Exp: Diferencia entre SO real y Exp SO",
    locations = cells_column_labels(columns = `%Diff SO y Exp`)
  ) %>%
  tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)), 
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )


# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_rece_flot, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_rece_flot.html")

```

```{r}
# Crear el gráfico con ajustes en los ejes
grafico_rec_avg_vs_so_flot <- ggplot(teams_info, aes(x = `Porcentaje_SO_flot`, y = Rec_AVG_flot, label = team, fill = team)) +
  scale_x_continuous(limits = c(54, 76), 
                     breaks = seq(54, 76, 2), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(2.5, 3.1), 
                     breaks = seq(2.5, 3.1, 0.1), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% SO",
       y = "Recepción AVG",
       title = expression(paste(bold("%SO FLOT vs Recepción AVG FLOT"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Porcentaje_SO_flot`, y = `Rec_AVG_flot`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)

# Mostrar el gráfico
print(grafico_rec_avg_vs_so_flot)

# Guardar la tabla como un archivo PNG
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/rec_vs_so_flot.png", plot = grafico_rec_avg_vs_so_flot, width = 8, height = 6, units = "in", dpi = 300)


```


```{r}
# Calcular Saque_AVG para cada jugador
players_info <- players_info %>%
  mutate(
    Rec_AVG_flot = ifelse(Rec_Tot_flot > 0, round((Rec_Perf_flot * 5 + Rec_Pos_flot * 3 + Rec_Exc_flot * 2 + Rec_Neg_flot * 1 + Rec_Barra_flot * -1 + Rec_Error_flot * -2) / Rec_Tot_flot, 2), 0),
    
  )

top_receptores_flot <- players_info %>%
 mutate(
    `% Rec Error_flot` = round((Rec_Error_flot / Rec_Tot_flot) * 100, 2),
    `% Rec Barra_flot` = round((Rec_Barra_flot / Rec_Tot_flot) * 100, 2),
    `% Rec Neg_flot` = round((Rec_Neg_flot / Rec_Tot_flot) * 100, 2),
    `% Rec Exc_flot` = round((Rec_Exc_flot / Rec_Tot_flot) * 100, 2),
    `% Rec Pos_flot` = round((Rec_Pos_flot / Rec_Tot_flot) * 100, 2),
    `% Rec Perf_flot` = round((Rec_Perf_flot / Rec_Tot_flot) * 100, 2),
    `% Rec Eficacia_flot` = ifelse(Rec_Tot_flot > 0, round((Rec_Perf_flot + Rec_Pos_flot) / Rec_Tot * 100, 2), 0),
    `% Rec Eficiencia_flot` = ifelse(Rec_Tot_flot > 0, round((Rec_Perf_flot + Rec_Pos_flot - (Rec_Error_flot + Rec_Barra_flot)) / Rec_Tot_flot, 2), 0)
  )


# Obtener los top 10 jugadores con mejor Saque_AVG
top_receptores_flot <- top_receptores_flot %>%
     filter(Rec_Tot_flot >= 50)%>%
  arrange(desc(`Rec_AVG_flot`)) %>%
  head(15)
```


```{r}
# Crear la tabla con los 10 mejores receptores
tabla_top_receptores_flot <- top_receptores_flot %>%
  arrange(desc(Rec_AVG_flot))%>%
  mutate(Rank = row_number())%>%
    select(
    Rank,
    Jugador = player_name,
    Sets = sets_played,
    Posicion = player_rol,
    `Nº Rec` = Rec_Tot_flot,
    `Rec AVG` = Rec_AVG_flot,
    `% Rec Eficiencia` = `% Rec Eficiencia_flot`,
    `% Rec Eficacia` = `% Rec Eficacia_flot`,
    `% Rec #` = `% Rec Perf_flot`,
    `% Rec +` = `% Rec Pos_flot`,
    `% Rec !` = `% Rec Exc_flot`,
    `% Rec -` = `% Rec Neg_flot`,
    `% Rec /` = `% Rec Barra_flot`,
    `% Rec =` = `% Rec Error_flot`,
  ) %>%
  gt() %>%
  gt::data_color(
    columns = "Rec AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec +", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec #", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec /", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% Rec =", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Top 15 jugadores recepción FLOT',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Rec AVG = Valoración media atendiendo a: Rec #: 5, Rec +: 3, Rec !: 2, Rec -: 1, Rec /: -1,  Rec =: -2",
    locations = cells_column_labels(columns = `Rec AVG`)
  ) %>%
  tab_footnote(
    footnote = "Mínimo de recepciones: 50",
    locations = cells_title(groups = "title")
  )%>%
  tab_footnote(
    footnote = "Ranking mejores jugadores en RECEPCIÓN FLOT atendiendo a Rec AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_top_receptores_flot, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_rece_flot.html")

```


//////// RECEPCION SALTO


```{r}
# Obtener estadísticas adicionales por equipo
teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "reception" & skill_type == "jump serve reception") %>%
              group_by(team) %>%
              summarise(
                Rec_Tot_jump = n(),
                Rec_Perf_jump = sum(evaluation_code == "#"),
                Rec_Pos_jump = sum(evaluation_code == "+"),
                Rec_Exc_jump = sum(evaluation_code == "!"),
                Rec_Neg_jump = sum(evaluation_code == "-"),
                Rec_Barra_jump = sum(evaluation_code == "/"),
                Rec_Error_jump = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Rec Perf_jump` = round((Rec_Perf_jump / Rec_Tot_jump) * 100, 2),
            `% Rec Pos_jump` = round((Rec_Pos_jump / Rec_Tot_jump) * 100, 2),
            `% Rec Exc_jump` = round((Rec_Exc_jump / Rec_Tot_jump) * 100, 2),
            `% Rec Neg_jump` = round((Rec_Neg_jump / Rec_Tot_jump) * 100, 2),
            `% Rec Barra_jump` = round((Rec_Barra_jump / Rec_Tot_jump) * 100, 2),
            `% Rec Error_jump` = round((Rec_Error_jump / Rec_Tot_jump) * 100, 2),
            `% Rec Eficacia_jump` = ifelse(Rec_Tot_jump > 0, round((Rec_Perf_jump + Rec_Pos_jump) / Rec_Tot_jump * 100, 2), 0),
            `% Rec Eficiencia_jump` = ifelse(Rec_Tot_jump > 0, round((Rec_Perf_jump + Rec_Pos_jump - (Rec_Error_jump + Rec_Barra_jump)) / Rec_Tot_jump, 2), 0),
            Rec_AVG_jump = ifelse(Rec_Tot_jump > 0, round((Rec_Perf_jump * 5 + Rec_Pos_jump * 3 + Rec_Exc_jump * 2 + Rec_Neg_jump * 1  + Rec_Barra_jump *                          -1 + Rec_Error_jump * -2) / Rec_Tot_jump, 2), 0),
    )

```


```{r}
sideout_jump <- df %>%
  filter(point_won_by != serving_team & team == point_won_by) %>%
  filter(skill == "reception" & skill_type == "jump serve reception")%>%
  group_by(team) %>%                         
  summarise(SO_jump = n())                        # Contar nº sideouts
```


```{r}
teams_info <- teams_info %>%
  left_join(
    sideout_jump,
    by = "team"
  ) %>%
  mutate(
    Porcentaje_SO_jump = round((SO_jump / Rec_Tot_jump) * 100, 2)
  )
```

```{r}

# Calcular el promedio ponderado para cada equipo
teams_info <- teams_info %>%
  mutate(
    `%Exp SO_jump` = round(( (Rec_Perf_jump * 63.9) + (Rec_Pos_jump * 62.9) + (Rec_Exc_jump * 60.7) + (Rec_Neg_jump * 54.2) + 
                   (Rec_Barra_jump * 33.4) + (Rec_Error_jump * 0.0) ) / Rec_Tot_jump ,2)
  )
```

```{r}

# Calcular %Diff BP y Exp
teams_info <- teams_info %>%
  mutate(`%Diff SO y Exp_jump` = `Porcentaje_SO_jump` - `%Exp SO_jump` )
```


```{r}
library(gt)

# Crear la tabla con la información de teams_info
tabla_equipos_rece_jump <- teams_info  %>%
  arrange(desc(Rec_AVG_jump)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `% SO` = Porcentaje_SO_jump,
    `%Exp SO` = `%Exp SO_jump`,
    `%Diff SO y Exp` = `%Diff SO y Exp_jump`,
    
    `Nº Rec` = Rec_Tot_jump,
    `Rec AVG` = Rec_AVG_jump,
    
    `% Rec Eficiencia` = `% Rec Eficiencia_jump`,
    `% Rec Eficacia` = `% Rec Eficacia_jump`,
    
    `Rec Perf` = Rec_Perf_jump,
    `% Rec #` = `% Rec Perf_jump`,
    
    `Rec Pos` = Rec_Pos_jump,
    `% Rec +` = `% Rec Pos_jump`,
    `Rec Exc` = Rec_Exc_jump,
    `Rec Neg` = Rec_Neg_jump,
    
    `Rec Barra` = Rec_Barra_jump,
    `% Rec /` = `% Rec Barra_jump`,
    `Rec Error` = Rec_Error_jump,
    `% Rec =` = `% Rec Error_jump`,
    
  ) %>%
  gt() %>%
  gt::data_color(
    columns = "Rec AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% SO", colors = c("ivory2", "deepskyblue3")
  )%>%
  gt::data_color(
    columns = "%Exp SO", colors = c("ivory2", "deepskyblue3")
  )%>%
  gt::data_color(
    columns = "%Diff SO y Exp", colors = c("ivory2", "deepskyblue3")
  )%>%
  gt::data_color(
    columns = "% Rec Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec +", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec #", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec /", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% Rec =", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Recepción POTENCIA por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Rec AVG = Valoración media atendiendo a: Rec #: 5, Rec +: 3, Rec !: 2, Rec -: 1, Rec /: -1,  Rec =: -2",
    locations = cells_column_labels(columns = `Rec AVG`)
  ) %>%
  tab_footnote(
    footnote = "Ranking mejores equipos en recepción POTENCIA atendiendo a Rec AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
  tab_footnote(
    footnote = "%Exp SO (%Expected Sideout): Rec #: 0.639, Rec +: 0.634, Rec !: 0.607, Rec -: 0.542, Rec /: 0.334, Rec =: 0.00",
    locations = cells_column_labels(columns = `%Exp SO`)
  ) %>%
  tab_footnote(
    footnote = "%Diff SO y Exp: Diferencia entre SO real y Exp SO",
    locations = cells_column_labels(columns = `%Diff SO y Exp`)
  ) %>%
  tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    data_row.padding = px(2),
    summary_row.padding = px(3),
    row_group.padding = px(4) 
  )%>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)), 
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )



# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_rece_jump, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_rece_jump.html")

```


```{r}
# Crear el gráfico con ajustes en los ejes
grafico_rec_avg_vs_so_jump <- ggplot(teams_info, aes(x = `Porcentaje_SO_jump`, y = Rec_AVG_jump, label = team, fill = team)) +
  scale_x_continuous(limits = c(50, 64), 
                     breaks = seq(50, 64, 2), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(1.5, 2.5), 
                     breaks = seq(1.5, 2.5, 0.1), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% SO",
       y = "Recepción AVG",
       title = expression(paste(bold("%SO POT vs Recepción AVG POT"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Porcentaje_SO_jump`, y = `Rec_AVG_jump`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)

# Mostrar el gráfico
print(grafico_rec_avg_vs_so_jump)

# Guardar la tabla como un archivo PNG
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/rec_vs_so_jump.png", plot = grafico_rec_avg_vs_so_jump, width = 8, height = 6, units = "in", dpi = 300)


```



```{r}
# Calcular Saque_AVG para cada jugador
players_info <- players_info %>%
  mutate(
    Rec_AVG_jump = ifelse(Rec_Tot_jump > 0, round((Rec_Perf_jump * 5 + Rec_Pos_jump * 3 + Rec_Exc_jump * 2 + Rec_Neg_jump * 1 + Rec_Barra_jump * -1 + Rec_Error_jump * -2) / Rec_Tot_jump, 2), 0),
    
  )

top_receptores_jump <- players_info %>%
 mutate(
    `% Rec Error_jump` = round((Rec_Error_jump / Rec_Tot_jump) * 100, 2),
    `% Rec Barra_jump` = round((Rec_Barra_jump / Rec_Tot_jump) * 100, 2),
    `% Rec Neg_jump` = round((Rec_Neg_jump / Rec_Tot_jump) * 100, 2),
    `% Rec Exc_jump` = round((Rec_Exc_jump / Rec_Tot_jump) * 100, 2),
    `% Rec Pos_jump` = round((Rec_Pos_jump / Rec_Tot_jump) * 100, 2),
    `% Rec Perf_jump` = round((Rec_Perf_jump / Rec_Tot_jump) * 100, 2),
    `% Rec Eficacia_jump` = ifelse(Rec_Tot_jump > 0, round((Rec_Perf_jump + Rec_Pos_jump) / Rec_Tot * 100, 2), 0),
    `% Rec Eficiencia_jump` = ifelse(Rec_Tot_jump > 0, round((Rec_Perf_jump + Rec_Pos_jump - (Rec_Error_jump + Rec_Barra_jump)) / Rec_Tot_jump, 2), 0)
  )


# Obtener los top 10 jugadores con mejor Saque_AVG
top_receptores_jump <- top_receptores_jump %>%
     filter(Rec_Tot_jump >= 50)%>%
  arrange(desc(`Rec_AVG_jump`)) %>%
  head(15)
```


```{r}
# Crear la tabla con los 10 mejores receptores
tabla_top_receptores_jump <- top_receptores_jump %>%
  arrange(desc(Rec_AVG_jump))%>%
  mutate(Rank = row_number())%>%
    select(
    Rank,
    Jugador = player_name,
    Sets = sets_played,
    Posicion = player_rol,
    `Nº Rec` = Rec_Tot_jump,
    `Rec AVG` = Rec_AVG_jump,
    `% Rec Eficiencia` = `% Rec Eficiencia_jump`,
    `% Rec Eficacia` = `% Rec Eficacia_jump`,
    `% Rec #` = `% Rec Perf_jump`,
    `% Rec +` = `% Rec Pos_jump`,
    `% Rec !` = `% Rec Exc_jump`,
    `% Rec -` = `% Rec Neg_jump`,
    `% Rec /` = `% Rec Barra_jump`,
    `% Rec =` = `% Rec Error_jump`,
  ) %>%
  gt() %>%
  gt::data_color(
    columns = "Rec AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec +", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec #", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Rec /", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% Rec =", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Top 15 jugadores recepción POTENCIA',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Rec AVG = Valoración media atendiendo a: Rec #: 5, Rec +: 3, Rec !: 2, Rec -: 1, Rec /: -1,  Rec =: -2",
    locations = cells_column_labels(columns = `Rec AVG`)
  ) %>%
  tab_footnote(
    footnote = "Mínimo de recepciones: 50",
    locations = cells_title(groups = "title")
  )%>%
  tab_footnote(
    footnote = "Ranking mejores jugadores en RECEPCIÓN POTENCIA atendiendo a Rec AVG",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_top_receptores_jump, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_rece_jump.html")

```


//////// ATAQUE TODO


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack") %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot = n(),
                Ataque_Perf = sum(evaluation_code == "#"),
                Ataque_Pos = sum(evaluation_code == "+"),
                Ataque_Exc = sum(evaluation_code == "!"),
                Ataque_Neg = sum(evaluation_code == "-"),
                Ataque_Barra = sum(evaluation_code == "/"),
                Ataque_Error = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf` = round((Ataque_Perf / Ataque_Tot) * 100, 2),
            `% Ataque Pos` = round((Ataque_Pos / Ataque_Tot) * 100, 2),
            `% Ataque Exc` = round((Ataque_Exc / Ataque_Tot) * 100, 2),
            `% Ataque Neg` = round((Ataque_Neg / Ataque_Tot) * 100, 2),
            `% Ataque Barra` = round((Ataque_Barra / Ataque_Tot) * 100, 2),
            `% Ataque Error` = round((Ataque_Error / Ataque_Tot) * 100, 2),
            `% Ataque Eficacia` = ifelse(Ataque_Tot > 0, round(Ataque_Perf  / Ataque_Tot * 100, 2), 0),
            `% Ataque Eficiencia` = ifelse(Ataque_Tot > 0, round((Ataque_Perf - (Ataque_Error + Ataque_Barra)) / Ataque_Tot, 2), 0)
    )

```


```{r}
library(gt)

# Crear la tabla con la información de teams_info
tabla_equipos_Ataque <- teams_info  %>%
  arrange(desc(`% Ataque Eficiencia`)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque` = Ataque_Tot,
    `% Ataque Eficiencia` = `% Ataque Eficiencia`,
    `Ataque #` = Ataque_Perf,
    `% Ataque #` = `% Ataque Perf`,
     `Ataque /` = Ataque_Barra,
    `% Ataque /` = `% Ataque Barra`,
    `Ataque =` = Ataque_Error,
    `% Ataque =` = `% Ataque Error`,
  ) %>%
  gt() %>%
  gt::data_color(
    columns = "% Ataque Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Ataque #", colors = c("ivory2", "palegreen4")
  ) %>%
  gt::data_color(
    columns = "% Ataque /", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% Ataque =", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Ataque por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Ataque Eficiencia`)
  ) %>%
    tab_footnote(
    footnote = "Ranking mejores equipos en ataque atendiendo a % Eficiencia",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
    tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  
  text_transform(
    locations = cells_body(vars(Equipo)),  # Aplicar la transformación solo a la columna "Equipo"
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )


# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque.html")

```

```{r}
# Crear el gráfico con ajustes en los ejes
grafico_rec_avg_vs_so <- ggplot(teams_info, aes(x = `Porcentaje_SO`, y = Rec_AVG, label = team, fill = team)) +
  scale_x_continuous(limits = c(52, 66), 
                     breaks = seq(52, 66, 2), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(2, 2.5), 
                     breaks = seq(2, 2.5, 0.1), 
                     labels = scales::number_format(accuracy = 0.1), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% SO",
       y = "Recepción AVG",
       title = expression(paste(bold("%SO vs Recepción AVG"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Porcentaje_SO`, y = `Rec_AVG`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)

# Mostrar el gráfico
print(grafico_rec_avg_vs_so)

# Guardar la tabla como un archivo PNG
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/rec_vs_so.png", plot = grafico_rec_avg_vs_so, width = 8, height = 6, units = "in", dpi = 300)


```


```{r}
# Crear el gráfico correspondiente al ataque
grafico_ataque_total <- ggplot(teams_info, aes(x = `Ataque_Tot`, y = `% Ataque Eficiencia`, label = team, fill = team)) +
  scale_x_continuous(limits = c(1800, 2700), 
                     breaks = seq(1800, 2700, 100), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0.15, 0.40), 
                     breaks = seq(0.15, 0.40, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº ataques",
       y = "% Eficiencia",
       title = expression(paste(bold("% Eficiencia Ataque"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Ataque_Tot`, y = `% Ataque Eficiencia`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)

# Mostrar el gráfico
print(grafico_ataque_total)

# Guardar el gráfico como un archivo PNG
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/ataque_total.png", plot = grafico_ataque_total, width = 8, height = 6, units = "in", dpi = 300)


```





//////// ATAQUE FBSO dependiendo de tipo de recepcion






```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_phase == "reception") %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_fbso = n(),
                Ataque_Perf_fbso = sum(evaluation_code == "#"),
                Ataque_Pos_fbso = sum(evaluation_code == "+"),
                Ataque_Exc_fbso = sum(evaluation_code == "!"),
                Ataque_Neg_fbso = sum(evaluation_code == "-"),
                Ataque_Barra_fbso = sum(evaluation_code == "/"),
                Ataque_Error_fbso = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_fbso` = round((Ataque_Perf_fbso / Ataque_Tot_fbso) * 100, 2),
            `% Ataque Pos_fbso` = round((Ataque_Pos_fbso / Ataque_Tot_fbso) * 100, 2),
            `% Ataque Exc_fbso` = round((Ataque_Exc_fbso / Ataque_Tot_fbso) * 100, 2),
            `% Ataque Neg_fbso` = round((Ataque_Neg_fbso / Ataque_Tot_fbso) * 100, 2),
            `% Ataque Barra_fbso` = round((Ataque_Barra_fbso / Ataque_Tot_fbso) * 100, 2),
            `% Ataque Error_fbso` = round((Ataque_Error_fbso / Ataque_Tot_fbso) * 100, 2),
            `% Ataque Eficacia_fbso` = ifelse(Ataque_Tot_fbso > 0, round(Ataque_Perf_fbso  / Ataque_Tot_fbso * 100, 2), 0),
            `% Ataque Eficiencia_fbso` = ifelse(Ataque_Tot_fbso > 0, round((Ataque_Perf_fbso - (Ataque_Error_fbso + Ataque_Barra_fbso)) / Ataque_Tot_fbso, 2), 0)
    )

```


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_phase == "reception") %>%
              filter (reception_quality =="#" | reception_quality == "+")%>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_fbso_rec1 = n(),
                Ataque_Perf_fbso_rec1 = sum(evaluation_code == "#"),
                Ataque_Pos_fbso_rec1 = sum(evaluation_code == "+"),
                Ataque_Exc_fbso_rec1 = sum(evaluation_code == "!"),
                Ataque_Neg_fbso_rec1 = sum(evaluation_code == "-"),
                Ataque_Barra_fbso_rec1 = sum(evaluation_code == "/"),
                Ataque_Error_fbso_rec1 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_fbso_rec1` = round((Ataque_Perf_fbso_rec1 / Ataque_Tot_fbso_rec1) * 100, 2),
            `% Ataque Pos_fbso_rec1` = round((Ataque_Pos_fbso_rec1 / Ataque_Tot_fbso_rec1) * 100, 2),
            `% Ataque Exc_fbso_rec1` = round((Ataque_Exc_fbso_rec1 / Ataque_Tot_fbso_rec1) * 100, 2),
            `% Ataque Neg_fbso_rec1` = round((Ataque_Neg_fbso_rec1 / Ataque_Tot_fbso_rec1) * 100, 2),
            `% Ataque Barra_fbso_rec1` = round((Ataque_Barra_fbso_rec1 / Ataque_Tot_fbso_rec1) * 100, 2),
            `% Ataque Error_fbso_rec1` = round((Ataque_Error_fbso_rec1 / Ataque_Tot_fbso_rec1) * 100, 2),
            `% Ataque Eficacia_fbso_rec1` = ifelse(Ataque_Tot_fbso_rec1 > 0, round(Ataque_Perf_fbso_rec1  / Ataque_Tot_fbso_rec1 * 100, 2), 0),
            `% Ataque Eficiencia_fbso_rec1` = ifelse(Ataque_Tot_fbso_rec1 > 0, round((Ataque_Perf_fbso_rec1 - (Ataque_Error_fbso_rec1 + Ataque_Barra_fbso_rec1)) / Ataque_Tot_fbso_rec1, 2), 0)
    )

```


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_phase == "reception") %>%
              filter (reception_quality =="!") %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_fbso_rec2 = n(),
                Ataque_Perf_fbso_rec2 = sum(evaluation_code == "#"),
                Ataque_Pos_fbso_rec2 = sum(evaluation_code == "+"),
                Ataque_Exc_fbso_rec2 = sum(evaluation_code == "!"),
                Ataque_Neg_fbso_rec2 = sum(evaluation_code == "-"),
                Ataque_Barra_fbso_rec2 = sum(evaluation_code == "/"),
                Ataque_Error_fbso_rec2 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_fbso_rec2` = round((Ataque_Perf_fbso_rec2 / Ataque_Tot_fbso_rec2) * 100, 2),
            `% Ataque Pos_fbso_rec2` = round((Ataque_Pos_fbso_rec2 / Ataque_Tot_fbso_rec2) * 100, 2),
            `% Ataque Exc_fbso_rec2` = round((Ataque_Exc_fbso_rec2 / Ataque_Tot_fbso_rec2) * 100, 2),
            `% Ataque Neg_fbso_rec2` = round((Ataque_Neg_fbso_rec2 / Ataque_Tot_fbso_rec2) * 100, 2),
            `% Ataque Barra_fbso_rec2` = round((Ataque_Barra_fbso_rec2 / Ataque_Tot_fbso_rec2) * 100, 2),
            `% Ataque Error_fbso_rec2` = round((Ataque_Error_fbso_rec2 / Ataque_Tot_fbso_rec2) * 100, 2),
            `% Ataque Eficacia_fbso_rec2` = ifelse(Ataque_Tot_fbso_rec2 > 0, round(Ataque_Perf_fbso_rec2  / Ataque_Tot_fbso_rec2 * 100, 2), 0),
            `% Ataque Eficiencia_fbso_rec2` = ifelse(Ataque_Tot_fbso_rec2 > 0, round((Ataque_Perf_fbso_rec2 - (Ataque_Error_fbso_rec2 + Ataque_Barra_fbso_rec2)) / Ataque_Tot_fbso_rec2, 2), 0)
    )

```


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_phase == "reception") %>%
              filter (reception_quality =="-") %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_fbso_rec3 = n(),
                Ataque_Perf_fbso_rec3 = sum(evaluation_code == "#"),
                Ataque_Pos_fbso_rec3 = sum(evaluation_code == "+"),
                Ataque_Exc_fbso_rec3 = sum(evaluation_code == "!"),
                Ataque_Neg_fbso_rec3 = sum(evaluation_code == "-"),
                Ataque_Barra_fbso_rec3 = sum(evaluation_code == "/"),
                Ataque_Error_fbso_rec3 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_fbso_rec3` = round((Ataque_Perf_fbso_rec3 / Ataque_Tot_fbso_rec3) * 100, 2),
            `% Ataque Pos_fbso_rec3` = round((Ataque_Pos_fbso_rec3 / Ataque_Tot_fbso_rec3) * 100, 2),
            `% Ataque Exc_fbso_rec3` = round((Ataque_Exc_fbso_rec3 / Ataque_Tot_fbso_rec3) * 100, 2),
            `% Ataque Neg_fbso_rec3` = round((Ataque_Neg_fbso_rec3 / Ataque_Tot_fbso_rec3) * 100, 2),
            `% Ataque Barra_fbso_rec3` = round((Ataque_Barra_fbso_rec3 / Ataque_Tot_fbso_rec3) * 100, 2),
            `% Ataque Error_fbso_rec3` = round((Ataque_Error_fbso_rec3 / Ataque_Tot_fbso_rec3) * 100, 2),
            `% Ataque Eficacia_fbso_rec3` = ifelse(Ataque_Tot_fbso_rec3 > 0, round(Ataque_Perf_fbso_rec3  / Ataque_Tot_fbso_rec3 * 100, 2), 0),
            `% Ataque Eficiencia_fbso_rec3` = ifelse(Ataque_Tot_fbso_rec3 > 0, round((Ataque_Perf_fbso_rec3 - (Ataque_Error_fbso_rec3 + Ataque_Barra_fbso_rec3)) / Ataque_Tot_fbso_rec3, 2), 0)
    )

```


```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_equipos_Ataque_fbso_combined <- teams_info %>%
  arrange(desc(`% Ataque Eficiencia_fbso_rec1`)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque (#+)` = Ataque_Tot_fbso_rec1,
    `% Eficiencia (#+)` = `% Ataque Eficiencia_fbso_rec1`,
    `% Eficacia (#+)` = `% Ataque Eficacia_fbso_rec1`,
    `% = (#+)` = `% Ataque Error_fbso_rec1`,
    `% / (#+)` = `% Ataque Barra_fbso_rec1`,
    
    `Nº Ataque (!)` = Ataque_Tot_fbso_rec2,
    `% Eficiencia (!)` = `% Ataque Eficiencia_fbso_rec2`,
    `% Eficacia (!)` = `% Ataque Eficacia_fbso_rec2`,
    `% = (!)` = `% Ataque Error_fbso_rec2`,
    `% / (!)` = `% Ataque Barra_fbso_rec2`,

  
    `Nº Ataque (-)` = Ataque_Tot_fbso_rec3,
    `% Eficiencia (-)` = `% Ataque Eficiencia_fbso_rec3`,
    `% Eficacia (-)` = `% Ataque Eficacia_fbso_rec3`,
    `% = (-)` = `% Ataque Error_fbso_rec3`,
    `% / (-)` = `% Ataque Barra_fbso_rec3`
  ) %>%
  gt() %>%
  tab_spanner(
    label = "Rec #+",
    columns = c(`Nº Ataque (#+)`, `% Eficiencia (#+)`, `% Eficacia (#+)`, `% = (#+)`, `% / (#+)`)
  ) %>%
  tab_spanner(
    label = "Rec !",
    columns = c(`Nº Ataque (!)`, `% Eficiencia (!)`, `% Eficacia (!)`, `% = (!)`, `% / (!)`)
  ) %>%
  tab_spanner(
    label = "Rec -",
    columns = c(`Nº Ataque (-)`, `% Eficiencia (-)`, `% Eficacia (-)`, `% = (-)`, `% / (-)`)
  ) %>%
  tab_header(
    title = 'Ataque FBSO por equipo',
    subtitle = 'Estadísticas de ataque por equipo en la primera acción después de recepción (First Ball Side Out)'
  ) %>%
  gt::data_color(
    columns = "% Eficiencia (#+)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Eficacia (#+)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = (#+)", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / (#+)", colors = c("ivory2", "brown1")
  ) %>%
   gt::data_color(
    columns = "% Eficiencia (!)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Eficacia (!)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = (!)", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / (!)", colors = c("ivory2", "brown1")
  ) %>%
   gt::data_color(
    columns = "% Eficiencia (-)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Eficacia (-)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = (-)", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / (-)", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Ataque FBSO por equipo (First ball side out)',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia (#+)`)
  )%>%
  tab_footnote(
    footnote = "Ranking por % Eficiencia en ataque FBSO con recepción #+",
    locations = cells_column_labels(columns = `Rank`)
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))%>%
  
  text_transform(
    locations = cells_body(vars(Equipo)),  # Aplicar la transformación solo a la columna "Equipo"
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )
  
  
# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque_fbso_combined, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque_fbso.html")

```


```{r}
# Crear el gráfico correspondiente al ataque
grafico_ataque_total <- ggplot(teams_info, aes(x = `Ataque_Tot`, y = `% Ataque Eficiencia`, label = team, fill = team)) +
  scale_x_continuous(limits = c(1800, 2700), 
                     breaks = seq(1800, 2700, 100), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0.15, 0.40), 
                     breaks = seq(0.15, 0.40, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº ataques",
       y = "% Eficiencia",
       title = expression(paste(bold("% Eficiencia Ataque"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Ataque_Tot`, y = `% Ataque Eficiencia`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)

# Mostrar el gráfico
print(grafico_ataque_total)

# Guardar el gráfico como un archivo PNG
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/ataque_total.png", plot = grafico_ataque_total, width = 8, height = 6, units = "in", dpi = 300)


```


```{r}
library(ggplot2)

# Gráfico para el tipo de recepción "#+"
grafico_ataque_rec1 <- ggplot(teams_info, aes(x = `Ataque_Tot_fbso_rec1`, y = `% Ataque Eficiencia_fbso_rec1`, label = team, fill = team)) +
  scale_x_continuous(limits = c(600, 950), 
                     breaks = seq(600, 950, 50), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0.25, 0.55), 
                     breaks = seq(0.25, 0.55, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº ataques",
       y = "% Eficiencia",
       title = expression(paste(bold("% Eficiencia FBSO tras rec #+"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Ataque_Tot_fbso_rec1`, y = `% Ataque Eficiencia_fbso_rec1`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
) 


print(grafico_ataque_rec1)
ggsave("ataque_fbso_rec1.png", plot = grafico_ataque_rec1, width = 8, height = 6, units = "in", dpi = 300)


# Gráfico para el tipo de recepción "!"
grafico_ataque_rec2 <- ggplot(teams_info, aes(x = `Ataque_Tot_fbso_rec2`, y = `% Ataque Eficiencia_fbso_rec2`, label = team, fill = team)) +
  scale_x_continuous(limits = c(200, 400), 
                     breaks = seq(200, 400, 25), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0.15, 0.40), 
                     breaks = seq(0.15, 0.40, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº ataques",
       y = "% Eficiencia",
       title = expression(paste(bold("% Eficiencia FBSO tras rec !"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Ataque_Tot_fbso_rec2`, y = `% Ataque Eficiencia_fbso_rec2`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
) 


print(grafico_ataque_rec2)
ggsave("ataque_fbso_rec2.png", plot = grafico_ataque_rec2, width = 8, height = 6, units = "in", dpi = 300)



# Gráfico para el tipo de recepción "-"
grafico_ataque_rec3 <- ggplot(teams_info, aes(x = `Ataque_Tot_fbso_rec3`, y = `% Ataque Eficiencia_fbso_rec3`, label = team, fill = team)) +
  scale_x_continuous(limits = c(200, 375), 
                     breaks = seq(200, 375, 25), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 0.35), 
                     breaks = seq(0, 0.35, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº ataques",
       y = "% Eficiencia",
       title = expression(paste(bold("% Eficiencia FBSO tras rec -"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Ataque_Tot_fbso_rec3`, y = `% Ataque Eficiencia_fbso_rec3`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
) 


print(grafico_ataque_rec3)
ggsave("ataque_fbso_rec3.png", plot = grafico_ataque_rec3, width = 8, height = 6, units = "in", dpi = 300)

```



// ATAQUE TRANSICION



```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack") %>%
              filter (attack_phase =="transition breakpoint" | attack_phase == "transition sideout") %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_trans = n(),
                Ataque_Perf_trans = sum(evaluation_code == "#"),
                Ataque_Pos_trans = sum(evaluation_code == "+"),
                Ataque_Exc_trans = sum(evaluation_code == "!"),
                Ataque_Neg_trans = sum(evaluation_code == "-"),
                Ataque_Barra_trans = sum(evaluation_code == "/"),
                Ataque_Error_trans = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_trans` = round((Ataque_Perf_trans / Ataque_Tot_trans) * 100, 2),
            `% Ataque Pos_trans` = round((Ataque_Pos_trans / Ataque_Tot_trans) * 100, 2),
            `% Ataque Exc_trans` = round((Ataque_Exc_trans / Ataque_Tot_trans) * 100, 2),
            `% Ataque Neg_trans` = round((Ataque_Neg_trans / Ataque_Tot_trans) * 100, 2),
            `% Ataque Barra_trans` = round((Ataque_Barra_trans / Ataque_Tot_trans) * 100, 2),
            `% Ataque Error_trans` = round((Ataque_Error_trans / Ataque_Tot_trans) * 100, 2),
            `% Ataque Eficacia_trans` = ifelse(Ataque_Tot_trans > 0, round(Ataque_Perf_trans  / Ataque_Tot_trans * 100, 2), 0),
            `% Ataque Eficiencia_trans` = ifelse(Ataque_Tot_trans > 0, round((Ataque_Perf_trans - (Ataque_Error_trans + Ataque_Barra_trans)) / Ataque_Tot_trans, 2), 0)
    )

```


```{r}
library(gt)

# Crear la tabla con la información de teams_info
tabla_equipos_Ataque_trans <- teams_info  %>%
  arrange(desc(`% Ataque Eficiencia_trans`)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque` = Ataque_Tot_trans,
    `% Ataque Eficiencia` = `% Ataque Eficiencia_trans`,
    `Ataque #` = Ataque_Perf_trans,
    `% Ataque #` = `% Ataque Perf_trans`,
    `Ataque /` = Ataque_Barra_trans,
    `% Ataque /` = `% Ataque Barra_trans`,
    `Ataque =` = Ataque_Error_trans,
    `% Ataque =` = `% Ataque Error_trans`,


  ) %>%
  gt() %>%
  gt::data_color(
    columns = "% Ataque Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Ataque #", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Ataque /", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% Ataque =", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Ataque Transición por equipo (rallies)',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Ataque Eficiencia`)
  ) %>%
    tab_footnote(
    footnote = "Ranking mejores equipos en ataque transición atendiendo a % Eficiencia",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  
  text_transform(
    locations = cells_body(vars(Equipo)),  # Aplicar la transformación solo a la columna "Equipo"
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )


# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque_trans, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque_trans.html")

```


```{r}
# Gráfico transicion"
grafico_ataque_trans <- ggplot(teams_info, aes(x = `Ataque_Tot_trans`, y = `% Ataque Eficiencia_trans`, label = team, fill = team)) +
  scale_x_continuous(limits = c(750, 1100), 
                     breaks = seq(750, 1100, 50), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0.15, 0.40), 
                     breaks = seq(0.15, 0.40, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº ataques",
       y = "% Eficiencia",
       title = expression(paste(bold("% Eficiencia ataque en transición"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Ataque_Tot_trans`, y = `% Ataque Eficiencia_trans`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
) 

# Mostrar el gráfico para "#+"
print(grafico_ataque_trans)

# Guardar el gráfico como un archivo PNG
ggsave("ataque_trans.png", plot = grafico_ataque_trans, width = 8, height = 6, units = "in", dpi = 300)
```



//// ATAQUES SEGUN BOLA ALTA vs BOLA RAPIDA


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("v5", "v3", "v6", "v8", "vp")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_high = n(),
                Ataque_Perf_high = sum(evaluation_code == "#"),
                Ataque_Pos_high = sum(evaluation_code == "+"),
                Ataque_Exc_high = sum(evaluation_code == "!"),
                Ataque_Neg_high = sum(evaluation_code == "-"),
                Ataque_Barra_high = sum(evaluation_code == "/"),
                Ataque_Error_high = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_high` = round((Ataque_Perf_high / Ataque_Tot_high) * 100, 2),
            `% Ataque Pos_high` = round((Ataque_Pos_high / Ataque_Tot_high) * 100, 2),
            `% Ataque Exc_high` = round((Ataque_Exc_high / Ataque_Tot_high) * 100, 2),
            `% Ataque Neg_high` = round((Ataque_Neg_high / Ataque_Tot_high) * 100, 2),
            `% Ataque Barra_high` = round((Ataque_Barra_high / Ataque_Tot_high) * 100, 2),
            `% Ataque Error_high` = round((Ataque_Error_high / Ataque_Tot_high) * 100, 2),
            `% Ataque Eficacia_high` = ifelse(Ataque_Tot_high > 0, round(Ataque_Perf_high  / Ataque_Tot_high * 100, 2), 0),
            `% Ataque Eficiencia_high` = ifelse(Ataque_Tot_high > 0, round((Ataque_Perf_high - (Ataque_Error_high + Ataque_Barra_high)) / Ataque_Tot_high, 2), 0)
    )
```


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("x5" , "x6", "x4", "x9", "x8", "xb", "xp", "c5", "c6", "c8")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_fast = n(),
                Ataque_Perf_fast = sum(evaluation_code == "#"),
                Ataque_Pos_fast = sum(evaluation_code == "+"),
                Ataque_Exc_fast = sum(evaluation_code == "!"),
                Ataque_Neg_fast = sum(evaluation_code == "-"),
                Ataque_Barra_fast = sum(evaluation_code == "/"),
                Ataque_Error_fast = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_fast` = round((Ataque_Perf_fast / Ataque_Tot_fast) * 100, 2),
            `% Ataque Pos_fast` = round((Ataque_Pos_fast / Ataque_Tot_fast) * 100, 2),
            `% Ataque Exc_fast` = round((Ataque_Exc_fast / Ataque_Tot_fast) * 100, 2),
            `% Ataque Neg_fast` = round((Ataque_Neg_fast / Ataque_Tot_fast) * 100, 2),
            `% Ataque Barra_fast` = round((Ataque_Barra_fast / Ataque_Tot_fast) * 100, 2),
            `% Ataque Error_fast` = round((Ataque_Error_fast / Ataque_Tot_fast) * 100, 2),
            `% Ataque Eficacia_fast` = ifelse(Ataque_Tot_fast > 0, round(Ataque_Perf_fast  / Ataque_Tot_fast * 100, 2), 0),
            `% Ataque Eficiencia_fast` = ifelse(Ataque_Tot_fast > 0, round((Ataque_Perf_fast - (Ataque_Error_fast + Ataque_Barra_fast)) / Ataque_Tot_fast, 2), 0)
    )
```



```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_equipos_Ataque_fast_vs_high <- teams_info %>%
  arrange(desc(`% Ataque Eficiencia_fast`)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque fast` = Ataque_Tot_fast,
    `% Eficiencia fast` = `% Ataque Eficiencia_fast`,
    `% # fast` = `% Ataque Eficacia_fast`,
    `% = fast` = `% Ataque Error_fast`,
    `% / fast` = `% Ataque Barra_fast`,

  
    `Nº Ataque high` = Ataque_Tot_high,
    `% Eficiencia high` = `% Ataque Eficiencia_high`,
    `% # high` = `% Ataque Eficacia_high`,
    `% = high` = `% Ataque Error_high`,
    `% / high` = `% Ataque Barra_high`
  ) %>%
  gt() %>%
  tab_spanner(
    label = "Bola rápida",
    columns = c(`Nº Ataque fast`, `% Eficiencia fast`, `% # fast`, `% = fast`, `% / fast`)
  ) %>%
  tab_spanner(
    label = "Bola alta",
    columns = c(`Nº Ataque high`, `% Eficiencia high`, `% # high`, `% = high`, `% / high`)
  ) %>%
  gt::data_color(
    columns = "% Eficiencia fast", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # fast", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = fast", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / fast", colors = c("ivory2", "brown1")
  ) %>%
   gt::data_color(
    columns = "% Eficiencia high", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # high", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = high", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / high", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Ataque por tipo de bola en banda por equipo (no 1er tiempo)',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia fast`)
  ) %>%
    tab_footnote(
    footnote = "Ranking mejores equipos en ataque bola rápida vs bola alta en bandas. No hay ataques de primer tiempo. No hay penalties",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)),  # Aplicar la transformación solo a la columna "Equipo"
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )

# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque_fast_vs_high, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque_fast_vs_high.html")

```


```{r}

grafico_ataque_fast_high <- ggplot(teams_info, aes(x = `% Ataque Eficiencia_fast`, y = `% Ataque Eficiencia_high`, label = team, fill = team))  +
  scale_x_continuous(limits = c(0.15, 0.45), 
                     breaks = seq(0.15, 0.45, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 0.25), 
                     breaks = seq(0, 0.25, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% Eficiencia rápida",
       y = "% Eficiencia alta",
       title = expression(paste(bold("% Eficiencia BOLA ALTA vs BOLA RAP"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `% Ataque Eficiencia_fast`, y = `% Ataque Eficiencia_high`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)  


print(grafico_ataque_fast_high)

# Guardar el gráfico como un archivo PNG
ggsave("ataque_fast_vs_high.png", plot = grafico_ataque_fast_high, width = 8, height = 6, units = "in", dpi = 300)

```


/// ATAQUE ZONA 4


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("v5")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_high4 = n(),
                Ataque_Perf_high4 = sum(evaluation_code == "#"),
                Ataque_Pos_high4 = sum(evaluation_code == "+"),
                Ataque_Exc_high4 = sum(evaluation_code == "!"),
                Ataque_Neg_high4 = sum(evaluation_code == "-"),
                Ataque_Barra_high4 = sum(evaluation_code == "/"),
                Ataque_Error_high4 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_high4` = round((Ataque_Perf_high4 / Ataque_Tot_high4) * 100, 2),
            `% Ataque Pos_high4` = round((Ataque_Pos_high4 / Ataque_Tot_high4) * 100, 2),
            `% Ataque Exc_high4` = round((Ataque_Exc_high4 / Ataque_Tot_high4) * 100, 2),
            `% Ataque Neg_high4` = round((Ataque_Neg_high4 / Ataque_Tot_high4) * 100, 2),
            `% Ataque Barra_high4` = round((Ataque_Barra_high4 / Ataque_Tot_high4) * 100, 2),
            `% Ataque Error_high4` = round((Ataque_Error_high4 / Ataque_Tot_high4) * 100, 2),
            `% Ataque Eficacia_high4` = ifelse(Ataque_Tot_high4 > 0, round(Ataque_Perf_high4  / Ataque_Tot_high4 * 100, 2), 0),
            `% Ataque Eficiencia_high4` = ifelse(Ataque_Tot_high4 > 0, round((Ataque_Perf_high4 - (Ataque_Error_high4 + Ataque_Barra_high4)) / Ataque_Tot_high4, 2), 0)
    )
```


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("x5", "x9", "c5", "c9")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_fast4 = n(),
                Ataque_Perf_fast4 = sum(evaluation_code == "#"),
                Ataque_Pos_fast4 = sum(evaluation_code == "+"),
                Ataque_Exc_fast4 = sum(evaluation_code == "!"),
                Ataque_Neg_fast4 = sum(evaluation_code == "-"),
                Ataque_Barra_fast4 = sum(evaluation_code == "/"),
                Ataque_Error_fast4 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_fast4` = round((Ataque_Perf_fast4 / Ataque_Tot_fast4) * 100, 2),
            `% Ataque Pos_fast4` = round((Ataque_Pos_fast4 / Ataque_Tot_fast4) * 100, 2),
            `% Ataque Exc_fast4` = round((Ataque_Exc_fast4 / Ataque_Tot_fast4) * 100, 2),
            `% Ataque Neg_fast4` = round((Ataque_Neg_fast4 / Ataque_Tot_fast4) * 100, 2),
            `% Ataque Barra_fast4` = round((Ataque_Barra_fast4 / Ataque_Tot_fast4) * 100, 2),
            `% Ataque Error_fast4` = round((Ataque_Error_fast4 / Ataque_Tot_fast4) * 100, 2),
            `% Ataque Eficacia_fast4` = ifelse(Ataque_Tot_fast4 > 0, round(Ataque_Perf_fast4  / Ataque_Tot_fast4 * 100, 2), 0),
            `% Ataque Eficiencia_fast4` = ifelse(Ataque_Tot_fast4 > 0, round((Ataque_Perf_fast4 - (Ataque_Error_fast4 + Ataque_Barra_fast4)) / Ataque_Tot_fast4, 2), 0)
    )
```



```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_equipos_Ataque_fast4_vs_high4 <- teams_info %>%
  arrange(desc(`% Ataque Eficiencia_fast4`)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque fast` = Ataque_Tot_fast4,
    `% Eficiencia fast` = `% Ataque Eficiencia_fast4`,
    `% # fast` = `% Ataque Eficacia_fast4`,
    `% = fast` = `% Ataque Error_fast4`,
    `% / fast` = `% Ataque Barra_fast4`,

  
    `Nº Ataque high` = Ataque_Tot_high4,
    `% Eficiencia high` = `% Ataque Eficiencia_high4`,
    `% # high` = `% Ataque Eficacia_high4`,
    `% = high` = `% Ataque Error_high4`,
    `% / high` = `% Ataque Barra_high4`
  ) %>%
  gt() %>%
  tab_spanner(
    label = "Bola rápida",
    columns = c(`Nº Ataque fast`, `% Eficiencia fast`, `% # fast`, `% = fast`, `% / fast`)
  ) %>%
  tab_spanner(
    label = "Bola alta",
    columns = c(`Nº Ataque high`, `% Eficiencia high`, `% # high`, `% = high`, `% / high`)
  )%>%
  gt::data_color(
    columns = "% Eficiencia fast", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # fast", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = fast", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / fast", colors = c("ivory2", "brown1")
  ) %>%
   gt::data_color(
    columns = "% Eficiencia high", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # high", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = high", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / high", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Ataque por tipo de bola en ZONA 4',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia fast`)
  ) %>%
    tab_footnote(
    footnote = "Ranking mejores equipos en ataque bola rápida vs bola alta en ZONA 4. No hay penalties.",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)),  # Aplicar la transformación solo a la columna "Equipo"
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )

# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque_fast4_vs_high4, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque_fast4_vs_high4.html")

```


```{r}

grafico_ataque_fast4_high4 <- ggplot(teams_info, aes(x = `% Ataque Eficiencia_fast4`, y = `% Ataque Eficiencia_high4`, label = team, fill=team)) +
  scale_x_continuous(limits = c(0.2, 0.45), 
                     breaks = seq(0.2, 0.45, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 0.3), 
                     breaks = seq(0, 0.3, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% Eficiencia rápida",
       y = "% Eficiencia alta",
       title = expression(paste(bold("% Eficiencia (ZONA 4) BOLA ALTA vs BOLA RAP"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `% Ataque Eficiencia_fast4`, y = `% Ataque Eficiencia_high4`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)  


print(grafico_ataque_fast4_high4)

# Guardar el gráfico como un archivo PNG
ggsave("ataque_fast4_vs_high4.png", plot = grafico_ataque_fast4_high4, width = 8, height = 6, units = "in", dpi = 300)

```



/// ATAQUE ZONA 2


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("v6")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_high2 = n(),
                Ataque_Perf_high2 = sum(evaluation_code == "#"),
                Ataque_Pos_high2 = sum(evaluation_code == "+"),
                Ataque_Exc_high2 = sum(evaluation_code == "!"),
                Ataque_Neg_high2 = sum(evaluation_code == "-"),
                Ataque_Barra_high2 = sum(evaluation_code == "/"),
                Ataque_Error_high2 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_high2` = round((Ataque_Perf_high2 / Ataque_Tot_high2) * 100, 2),
            `% Ataque Pos_high2` = round((Ataque_Pos_high2 / Ataque_Tot_high2) * 100, 2),
            `% Ataque Exc_high2` = round((Ataque_Exc_high2 / Ataque_Tot_high2) * 100, 2),
            `% Ataque Neg_high2` = round((Ataque_Neg_high2 / Ataque_Tot_high2) * 100, 2),
            `% Ataque Barra_high2` = round((Ataque_Barra_high2 / Ataque_Tot_high2) * 100, 2),
            `% Ataque Error_high2` = round((Ataque_Error_high2 / Ataque_Tot_high2) * 100, 2),
            `% Ataque Eficacia_high2` = ifelse(Ataque_Tot_high2 > 0, round(Ataque_Perf_high2  / Ataque_Tot_high2 * 100, 2), 0),
            `% Ataque Eficiencia_high2` = ifelse(Ataque_Tot_high2 > 0, round((Ataque_Perf_high2 - (Ataque_Error_high2 + Ataque_Barra_high2)) / Ataque_Tot_high2, 2), 0)
    )
```


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("x6", "x4", "c6", "x4")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_fast2 = n(),
                Ataque_Perf_fast2 = sum(evaluation_code == "#"),
                Ataque_Pos_fast2 = sum(evaluation_code == "+"),
                Ataque_Exc_fast2 = sum(evaluation_code == "!"),
                Ataque_Neg_fast2 = sum(evaluation_code == "-"),
                Ataque_Barra_fast2 = sum(evaluation_code == "/"),
                Ataque_Error_fast2 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_fast2` = round((Ataque_Perf_fast2 / Ataque_Tot_fast2) * 100, 2),
            `% Ataque Pos_fast2` = round((Ataque_Pos_fast2 / Ataque_Tot_fast2) * 100, 2),
            `% Ataque Exc_fast2` = round((Ataque_Exc_fast2 / Ataque_Tot_fast2) * 100, 2),
            `% Ataque Neg_fast2` = round((Ataque_Neg_fast2 / Ataque_Tot_fast2) * 100, 2),
            `% Ataque Barra_fast2` = round((Ataque_Barra_fast2 / Ataque_Tot_fast2) * 100, 2),
            `% Ataque Error_fast2` = round((Ataque_Error_fast2 / Ataque_Tot_fast2) * 100, 2),
            `% Ataque Eficacia_fast2` = ifelse(Ataque_Tot_fast2 > 0, round(Ataque_Perf_fast2  / Ataque_Tot_fast2 * 100, 2), 0),
            `% Ataque Eficiencia_fast2` = ifelse(Ataque_Tot_fast2 > 0, round((Ataque_Perf_fast2 - (Ataque_Error_fast2 + Ataque_Barra_fast2)) / Ataque_Tot_fast2, 2), 0)
    )
```



```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_equipos_Ataque_fast2_vs_high2 <- teams_info %>%
  arrange(desc(`% Ataque Eficiencia_fast2`)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque fast` = Ataque_Tot_fast2,
    `% Eficiencia fast` = `% Ataque Eficiencia_fast2`,
    `% # fast` = `% Ataque Eficacia_fast2`,
    `% = fast` = `% Ataque Error_fast2`,
    `% / fast` = `% Ataque Barra_fast2`,

  
    `Nº Ataque high` = Ataque_Tot_high2,
    `% Eficiencia high` = `% Ataque Eficiencia_high2`,
    `% # high` = `% Ataque Eficacia_high2`,
    `% = high` = `% Ataque Error_high2`,
    `% / high` = `% Ataque Barra_high2`
  ) %>%
  gt() %>%
  tab_spanner(
    label = "Bola rápida",
    columns = c(`Nº Ataque fast`, `% Eficiencia fast`, `% # fast`, `% = fast`, `% / fast`)
  ) %>%
  tab_spanner(
    label = "Bola alta",
    columns = c(`Nº Ataque high`, `% Eficiencia high`, `% # high`, `% = high`, `% / high`)
  )%>%
  gt::data_color(
    columns = "% Eficiencia fast", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # fast", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = fast", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / fast", colors = c("ivory2", "brown1")
  ) %>%
   gt::data_color(
    columns = "% Eficiencia high", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # high", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = high", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / high", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Ataque por tipo de bola en ZONA 2',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia fast`)
  ) %>%
    tab_footnote(
    footnote = "Ranking mejores equipos en ataque bola rápida vs bola alta en ZONA 2. No hay penalties.",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)),  # Aplicar la transformación solo a la columna "Equipo"
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )

# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque_fast2_vs_high2, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque_fast2_vs_high2.html")

```


```{r}

grafico_ataque_fast2_high2 <- ggplot(teams_info, aes(x = `% Ataque Eficiencia_fast2`, y = `% Ataque Eficiencia_high2`, label = team, fill=team)) +
  scale_x_continuous(limits = c(0.2, 0.5), 
                     breaks = seq(0.2, 0.5, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 0.3), 
                     breaks = seq(0, 0.3, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% Eficiencia rápida",
       y = "% Eficiencia alta",
       title = expression(paste(bold("% Eficiencia (ZONA 2) BOLA ALTA vs BOLA RAP"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `% Ataque Eficiencia_fast2`, y = `% Ataque Eficiencia_high2`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)  


print(grafico_ataque_fast2_high2)

# Guardar el gráfico como un archivo PNG
ggsave("ataque_fast2_vs_high2.png", plot = grafico_ataque_fast2_high2, width = 8, height = 6, units = "in", dpi = 300)

```


/// ATAQUE ZONA 1


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("v8")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_high1 = n(),
                Ataque_Perf_high1 = sum(evaluation_code == "#"),
                Ataque_Pos_high1 = sum(evaluation_code == "+"),
                Ataque_Exc_high1 = sum(evaluation_code == "!"),
                Ataque_Neg_high1 = sum(evaluation_code == "-"),
                Ataque_Barra_high1 = sum(evaluation_code == "/"),
                Ataque_Error_high1 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_high1` = round((Ataque_Perf_high1 / Ataque_Tot_high1) * 100, 2),
            `% Ataque Pos_high1` = round((Ataque_Pos_high1 / Ataque_Tot_high1) * 100, 2),
            `% Ataque Exc_high1` = round((Ataque_Exc_high1 / Ataque_Tot_high1) * 100, 2),
            `% Ataque Neg_high1` = round((Ataque_Neg_high1 / Ataque_Tot_high1) * 100, 2),
            `% Ataque Barra_high1` = round((Ataque_Barra_high1 / Ataque_Tot_high1) * 100, 2),
            `% Ataque Error_high1` = round((Ataque_Error_high1 / Ataque_Tot_high1) * 100, 2),
            `% Ataque Eficacia_high1` = ifelse(Ataque_Tot_high1 > 0, round(Ataque_Perf_high1  / Ataque_Tot_high1 * 100, 2), 0),
            `% Ataque Eficiencia_high1` = ifelse(Ataque_Tot_high1 > 0, round((Ataque_Perf_high1 - (Ataque_Error_high1 + Ataque_Barra_high1)) / Ataque_Tot_high1, 2), 0)
    )
```


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("x8", "c8")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_fas1 = n(),
                Ataque_Perf_fas1 = sum(evaluation_code == "#"),
                Ataque_Pos_fas1 = sum(evaluation_code == "+"),
                Ataque_Exc_fas1 = sum(evaluation_code == "!"),
                Ataque_Neg_fas1 = sum(evaluation_code == "-"),
                Ataque_Barra_fas1 = sum(evaluation_code == "/"),
                Ataque_Error_fas1 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_fas1` = round((Ataque_Perf_fas1 / Ataque_Tot_fas1) * 100, 2),
            `% Ataque Pos_fas1` = round((Ataque_Pos_fas1 / Ataque_Tot_fas1) * 100, 2),
            `% Ataque Exc_fas1` = round((Ataque_Exc_fas1 / Ataque_Tot_fas1) * 100, 2),
            `% Ataque Neg_fas1` = round((Ataque_Neg_fas1 / Ataque_Tot_fas1) * 100, 2),
            `% Ataque Barra_fas1` = round((Ataque_Barra_fas1 / Ataque_Tot_fas1) * 100, 2),
            `% Ataque Error_fas1` = round((Ataque_Error_fas1 / Ataque_Tot_fas1) * 100, 2),
            `% Ataque Eficacia_fas1` = ifelse(Ataque_Tot_fas1 > 0, round(Ataque_Perf_fas1  / Ataque_Tot_fas1 * 100, 2), 0),
            `% Ataque Eficiencia_fas1` = ifelse(Ataque_Tot_fas1 > 0, round((Ataque_Perf_fas1 - (Ataque_Error_fas1 + Ataque_Barra_fas1)) / Ataque_Tot_fas1, 2), 0)
    )
```



```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_equipos_Ataque_fas1_vs_high1 <- teams_info %>%
  arrange(desc(`% Ataque Eficiencia_fas1`)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque fast` = Ataque_Tot_fas1,
    `% Eficiencia fast` = `% Ataque Eficiencia_fas1`,
    `% # fast` = `% Ataque Eficacia_fas1`,
    `% = fast` = `% Ataque Error_fas1`,
    `% / fast` = `% Ataque Barra_fas1`,

  
    `Nº Ataque high` = Ataque_Tot_high1,
    `% Eficiencia high` = `% Ataque Eficiencia_high1`,
    `% # high` = `% Ataque Eficacia_high1`,
    `% = high` = `% Ataque Error_high1`,
    `% / high` = `% Ataque Barra_high1`
  ) %>%
  gt() %>%
  tab_spanner(
    label = "Bola rápida",
    columns = c(`Nº Ataque fast`, `% Eficiencia fast`, `% # fast`, `% = fast`, `% / fast`)
  ) %>%
  tab_spanner(
    label = "Bola alta",
    columns = c(`Nº Ataque high`, `% Eficiencia high`, `% # high`, `% = high`, `% / high`)
  ) %>%
  gt::data_color(
    columns = "% Eficiencia fast", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # fast", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = fast", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / fast", colors = c("ivory2", "brown1")
  ) %>%
   gt::data_color(
    columns = "% Eficiencia high", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # high", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = high", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / high", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Ataque por tipo de bola en ZONA 1',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia fast`)
  ) %>%
    tab_footnote(
    footnote = "Ranking mejores equipos en ataque bola rápida vs bola alta en ZONA 1. No hay penalties.",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)), 
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )

# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque_fas1_vs_high1, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque_fas1_vs_high1.html")

```


```{r}

grafico_ataque_fas1_high1 <- ggplot(teams_info, aes(x = `% Ataque Eficiencia_fas1`, y = `% Ataque Eficiencia_high1`, label = team, fill = team)) +
  scale_x_continuous(limits = c(0.15, 0.5), 
                     breaks = seq(0.15, 0.5, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(-0.15, 0.3), 
                     breaks = seq(-0.15, 0.3, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "% Eficiencia rápida",
       y = "% Eficiencia alta",
       title = expression(paste(bold("% Eficiencia (ZONA 1) BOLA ALTA vs BOLA RAP"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `% Ataque Eficiencia_fas1`, y = `% Ataque Eficiencia_high1`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)  

print(grafico_ataque_fas1_high1)

# Guardar el gráfico como un archivo PNG
ggsave("ataque_fas1_vs_high1.png", plot = grafico_ataque_fas1_high1, width = 8, height = 6, units = "in", dpi = 300)

```




/// ATAQUE ZONA 3


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("x1", "xc", "xm", "xd", "x2", "x7")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_3 = n(),
                Ataque_Perf_3 = sum(evaluation_code == "#"),
                Ataque_Pos_3 = sum(evaluation_code == "+"),
                Ataque_Exc_3 = sum(evaluation_code == "!"),
                Ataque_Neg_3 = sum(evaluation_code == "-"),
                Ataque_Barra_3 = sum(evaluation_code == "/"),
                Ataque_Error_3 = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_3` = round((Ataque_Perf_3 / Ataque_Tot_3) * 100, 2),
            `% Ataque Pos_3` = round((Ataque_Pos_3 / Ataque_Tot_3) * 100, 2),
            `% Ataque Exc_3` = round((Ataque_Exc_3 / Ataque_Tot_3) * 100, 2),
            `% Ataque Neg_3` = round((Ataque_Neg_3 / Ataque_Tot_3) * 100, 2),
            `% Ataque Barra_3` = round((Ataque_Barra_3 / Ataque_Tot_3) * 100, 2),
            `% Ataque Error_3` = round((Ataque_Error_3 / Ataque_Tot_3) * 100, 2),
            `% Ataque Eficacia_3` = ifelse(Ataque_Tot_3 > 0, round(Ataque_Perf_3  / Ataque_Tot_3 * 100, 2), 0),
            `% Ataque Eficiencia_3` = ifelse(Ataque_Tot_3 > 0, round((Ataque_Perf_3 - (Ataque_Error_3 + Ataque_Barra_3)) / Ataque_Tot_3, 2), 0)
    )
```


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("pr")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_3_otro = n(),
                Ataque_Perf_3_otro = sum(evaluation_code == "#"),
                Ataque_Pos_3_otro = sum(evaluation_code == "+"),
                Ataque_Exc_3_otro = sum(evaluation_code == "!"),
                Ataque_Neg_3_otro = sum(evaluation_code == "-"),
                Ataque_Barra_3_otro = sum(evaluation_code == "/"),
                Ataque_Error_3_otro = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_3_otro` = round((Ataque_Perf_3_otro / Ataque_Tot_3_otro) * 100, 2),
            `% Ataque Pos_3_otro` = round((Ataque_Pos_3_otro / Ataque_Tot_3_otro) * 100, 2),
            `% Ataque Exc_3_otro` = round((Ataque_Exc_3_otro / Ataque_Tot_3_otro) * 100, 2),
            `% Ataque Neg_3_otro` = round((Ataque_Neg_3_otro / Ataque_Tot_3_otro) * 100, 2),
            `% Ataque Barra_3_otro` = round((Ataque_Barra_3_otro / Ataque_Tot_3_otro) * 100, 2),
            `% Ataque Error_3_otro` = round((Ataque_Error_3_otro / Ataque_Tot_3_otro) * 100, 2),
            `% Ataque Eficacia_3_otro` = ifelse(Ataque_Tot_3_otro > 0, round(Ataque_Perf_3_otro  / Ataque_Tot_3_otro * 100, 2), 0),
            `% Ataque Eficiencia_3_otro` = ifelse(Ataque_Tot_3_otro > 0, round((Ataque_Perf_3_otro - (Ataque_Error_3_otro + Ataque_Barra_3_otro)) / Ataque_Tot_3_otro, 2), 0)
    )
```



```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_equipos_Ataque_3 <- teams_info %>%
  arrange(desc(`% Ataque Eficiencia_3`)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque` = Ataque_Tot_3,
    `% Eficiencia` = `% Ataque Eficiencia_3`,
    `% #` = `% Ataque Eficacia_3`,
    `% =` = `% Ataque Error_3`,
    `% /` = `% Ataque Barra_3`,
    
    `Nº Ataque (o)` = Ataque_Tot_3_otro,
    `% Eficiencia (o)` = `% Ataque Eficiencia_3_otro`,
    `% # (o)` = `% Ataque Eficacia_3_otro`,
    `% = (o)` = `% Ataque Error_3_otro`,
    `% / (o)` = `% Ataque Barra_3_otro`

  ) %>%
  gt() %>%
  tab_spanner(
    label = "Primer tiempo",
    columns = c(`Nº Ataque`, `% Eficiencia`, `% #`, `% =`, `% /`)
  ) %>%
  tab_spanner(
    label = "Penaltis",
    columns = c(`Nº Ataque (o)`, `% Eficiencia (o)`, `% # (o)`, `% = (o)`, `% / (o)`)
  ) %>%
  gt::data_color(
    columns = "% Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% #", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% =", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% /", colors = c("ivory2", "brown1")
  ) %>%
  gt::data_color(
    columns = "% Eficiencia (o)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # (o)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = (o)", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / (o)", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Ataque PRIMER TIEMPO por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia`)
  ) %>%
    tab_footnote(
    footnote = "Ranking mejores equipos en ataque PRIMER TIEMPO. (Corto-Gancho-Corto Atrás-Doble Gancho-Alma)",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)), 
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )

# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque_3, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque_3.html")

```


```{r}

grafico_ataque_3 <- ggplot(teams_info, aes(x = `Ataque_Tot_3`, y = `% Ataque Eficiencia_3`, label = team, fill=team)) +
  scale_x_continuous(limits = c(300, 550), 
                     breaks = seq(300, 550, 50), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(0.2, 0.6), 
                     breaks = seq(0.2, 0.6, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº ataques",
       y = "% Eficiencia",
       title = expression(paste(bold("% Eficiencia 1er TIEMPO"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Ataque_Tot_3`, y = `% Ataque Eficiencia_3`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)  
 


print(grafico_ataque_3)

# Guardar el gráfico como un archivo PNG
ggsave("ataque_3.png", plot = grafico_ataque_3, width = 8, height = 6, units = "in", dpi = 300)

```




/// ATAQUE PIPE


```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & attack_code %in% c("xp", "xb", "vp")) %>%
              group_by(team) %>%
              summarise(
                Ataque_Tot_pipe = n(),
                Ataque_Perf_pipe = sum(evaluation_code == "#"),
                Ataque_Pos_pipe = sum(evaluation_code == "+"),
                Ataque_Exc_pipe = sum(evaluation_code == "!"),
                Ataque_Neg_pipe = sum(evaluation_code == "-"),
                Ataque_Barra_pipe = sum(evaluation_code == "/"),
                Ataque_Error_pipe = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
            `% Ataque Perf_pipe` = round((Ataque_Perf_pipe / Ataque_Tot_pipe) * 100, 2),
            `% Ataque Pos_pipe` = round((Ataque_Pos_pipe / Ataque_Tot_pipe) * 100, 2),
            `% Ataque Exc_pipe` = round((Ataque_Exc_pipe / Ataque_Tot_pipe) * 100, 2),
            `% Ataque Neg_pipe` = round((Ataque_Neg_pipe / Ataque_Tot_pipe) * 100, 2),
            `% Ataque Barra_pipe` = round((Ataque_Barra_pipe / Ataque_Tot_pipe) * 100, 2),
            `% Ataque Error_pipe` = round((Ataque_Error_pipe / Ataque_Tot_pipe) * 100, 2),
            `% Ataque Eficacia_pipe` = ifelse(Ataque_Tot_pipe > 0, round(Ataque_Perf_pipe  / Ataque_Tot_pipe * 100, 2), 0),
            `% Ataque Eficiencia_pipe` = ifelse(Ataque_Tot_pipe > 0, round((Ataque_Perf_pipe - (Ataque_Error_pipe + Ataque_Barra_pipe)) / Ataque_Tot_pipe, 2), 0)
    )
```



```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_equipos_Ataque_pipe <- teams_info %>%
  arrange(desc(`% Ataque Eficiencia_pipe`)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque` = Ataque_Tot_pipe,
    `% Eficiencia` = `% Ataque Eficiencia_pipe`,
    `% #` = `% Ataque Eficacia_pipe`,
    `% =` = `% Ataque Error_pipe`,
    `% /` = `% Ataque Barra_pipe`

  ) %>%
  gt() %>%
  tab_spanner(
    label = "PIPE",
    columns = c(`Nº Ataque`, `% Eficiencia`, `% #`, `% =`, `% /`)
  )%>%
  gt::data_color(
    columns = "% Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% #", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% =", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% /", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Ataque PIPE por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia`)
  ) %>%
    tab_footnote(
    footnote = "Ranking mejores equipos en ataque PIPE",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)), 
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )

# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque_pipe, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque_pipe.html")

```


```{r}

grafico_ataque_pipe <- ggplot(teams_info, aes(x = `Ataque_Tot_pipe`, y = `% Ataque Eficiencia_pipe`, label = team, fill = team))  +
  scale_x_continuous(limits = c(0, 250), 
                     breaks = seq(0, 250, 50), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(-0.15, 0.5), 
                     breaks = seq(-0.15, 0.5, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº ataques",
       y = "% Eficiencia",
       title = expression(paste(bold("% Eficiencia PIPE"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Ataque_Tot_pipe`, y = `% Ataque Eficiencia_pipe`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)    


print(grafico_ataque_pipe)

# Guardar el gráfico como un archivo PNG
ggsave("ataque_pipe.png", plot = grafico_ataque_pipe, width = 8, height = 6, units = "in", dpi = 300)

```


///// ATAQUE SEGUN BLOQUEO

```{r}

teams_info <- teams_info %>%
  left_join(df_filtrado %>% filter(skill == "attack" & !is.na(num_players_numeric) & attack_code %in% c("x5" , "x6", "x4", "x9", "x8", "xb", "xp", "c5", "c6", "c8", "v5", "v3", "v6", "v8", "vp","x1", "xc", "xm", "xd", "x2", "x7"  )) %>%
              group_by(team) %>%
              summarise(
                Total_ataques_bl = n(),
                Total_ataques_0 = sum(num_players_numeric == 0),
                Total_ataques_puntos_0 = sum(num_players_numeric == 0 & evaluation_code == "#"),
                Total_ataques_error_0 = sum(num_players_numeric == 0 & evaluation_code == "="),
                Total_ataques_bloqueo_0 = sum(num_players_numeric == 0 & evaluation_code == "/"),
                
                Total_ataques_1 = sum(num_players_numeric == 1),
                Total_ataques_puntos_1 = sum(num_players_numeric == 1 & evaluation_code == "#"),
                Total_ataques_error_1 = sum(num_players_numeric == 1 & evaluation_code == "="),
                Total_ataques_bloqueo_1 = sum(num_players_numeric == 1 & evaluation_code == "/"),
                
                Total_ataques_2 = sum(num_players_numeric == 2) + sum(num_players_numeric == 4),
                Total_ataques_puntos_2 = sum(num_players_numeric == 2 & evaluation_code == "#") +
                  sum(num_players_numeric == 4 & evaluation_code == "#"),
                Total_ataques_error_2 = sum(num_players_numeric == 2 & evaluation_code == "=")+
                  sum(num_players_numeric == 4 & evaluation_code == "="),
                Total_ataques_bloqueo_2 = sum(num_players_numeric == 2 & evaluation_code == "/")+
                  sum(num_players_numeric == 4 & evaluation_code == "/"),
                
                Total_ataques_3 = sum(num_players_numeric == 3),
                Total_ataques_puntos_3 = sum(num_players_numeric == 3 & evaluation_code == "#"),
                Total_ataques_error_3 = sum(num_players_numeric == 3 & evaluation_code == "="),
                Total_ataques_bloqueo_3 = sum(num_players_numeric == 3 & evaluation_code == "/"),

              ),
            by = "team")%>%
     mutate(
            Eff_ataques_0 = round((Total_ataques_puntos_0 - Total_ataques_error_0 - Total_ataques_bloqueo_0) / Total_ataques_0, 2),
            Eff_ataques_1 = round((Total_ataques_puntos_1 - Total_ataques_error_1 - Total_ataques_bloqueo_1) / Total_ataques_1, 2),
            Eff_ataques_2 = round((Total_ataques_puntos_2 - Total_ataques_error_2 - Total_ataques_bloqueo_2) / Total_ataques_2, 2),
            Eff_ataques_3 = round((Total_ataques_puntos_3 - Total_ataques_error_3 - Total_ataques_bloqueo_3) / Total_ataques_3, 2),
            `% Punto_ataques_0` = round((Total_ataques_puntos_0 / Total_ataques_0) * 100, 2),
            `% Error_ataques_0` = round((Total_ataques_error_0 / Total_ataques_0) * 100, 2),
            `% Barra_ataques_0` = round((Total_ataques_bloqueo_0 / Total_ataques_0) * 100, 2),
            
            `% Punto_ataques_1` = round((Total_ataques_puntos_1 / Total_ataques_1) * 100, 2),
            `% Error_ataques_1` = round((Total_ataques_error_1 / Total_ataques_1) * 100, 2),
            `% Barra_ataques_1` = round((Total_ataques_bloqueo_1 / Total_ataques_1) * 100, 2),
            
            `% Punto_ataques_2` = round((Total_ataques_puntos_2 / Total_ataques_2) * 100, 2),
            `% Error_ataques_2` = round((Total_ataques_error_2 / Total_ataques_2) * 100, 2),
            `% Barra_ataques_2` = round((Total_ataques_bloqueo_2 / Total_ataques_2) * 100, 2),
            
            `% Punto_ataques_3` = round((Total_ataques_puntos_3 / Total_ataques_3) * 100, 2),
            `% Error_ataques_3` = round((Total_ataques_error_3 / Total_ataques_3) * 100, 2),
            `% Barra_ataques_3` = round((Total_ataques_bloqueo_3 / Total_ataques_3) * 100, 2),
    )

```


```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_equipos_Ataque_bloqueo <- teams_info %>%
  arrange(desc(Total_ataques_bl)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Nº Ataque` = Total_ataques_bl,
    
    `Nº ataque (vs 0)` = Total_ataques_0,
    `% Eficiencia (vs 0)` = Eff_ataques_0,
    `% # (vs 0)` = `% Punto_ataques_0`,
    `% = (vs 0)` = `% Error_ataques_0`,
    `% / (vs 0)` = `% Barra_ataques_0`,
    
    `Nº ataque (vs 1)` = Total_ataques_1,
    `% Eficiencia (vs 1)` = Eff_ataques_1,
    `% # (vs 1)` = `% Punto_ataques_1`,
    `% = (vs 1)` = `% Error_ataques_1`,
    `% / (vs 1)` = `% Barra_ataques_1`,
    
    `Nº ataque (vs 2)` = Total_ataques_2,
    `% Eficiencia (vs 2)` = Eff_ataques_2,
    `% # (vs 2)` = `% Punto_ataques_2`,
    `% = (vs 2)` = `% Error_ataques_2`,
    `% / (vs 2)` = `% Barra_ataques_2`,
    
    `Nº ataque (vs 3)` = Total_ataques_3,
    `% Eficiencia (vs 3)` = Eff_ataques_3,
    `% # (vs 3)` = `% Punto_ataques_3`,
    `% = (vs 3)` = `% Error_ataques_3`,
    `% / (vs 3)` = `% Barra_ataques_3`,

  ) %>%
  gt() %>%
  tab_spanner(
    label = "Sin bloqueo",
    columns = c(`Nº ataque (vs 0)`, `% Eficiencia (vs 0)`, `% # (vs 0)`, `% = (vs 0)`, `% / (vs 0)`)
  )%>%
  tab_spanner(
    label = "Bloqueo individual",
    columns = c(`Nº ataque (vs 1)`, `% Eficiencia (vs 1)`, `% # (vs 1)`, `% = (vs 1)`, `% / (vs 1)`)
  )%>%
  tab_spanner(
    label = "Bloqueo doble",
    columns = c(`Nº ataque (vs 2)`, `% Eficiencia (vs 2)`, `% # (vs 2)`, `% = (vs 2)`, `% / (vs 2)`)
  )%>%
  tab_spanner(
    label = "Bloqueo triple",
    columns = c(`Nº ataque (vs 3)`, `% Eficiencia (vs 3)`, `% # (vs 3)`, `% = (vs 3)`, `% / (vs 3)`)
  )%>%
  gt::data_color(
    columns = "% Eficiencia (vs 0)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Eficiencia (vs 1)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Eficiencia (vs 2)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Eficiencia (vs 3)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # (vs 0)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # (vs 1)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # (vs 2)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% # (vs 3)", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% = (vs 0)", colors = c("ivory2", "brown1")
  )  %>%
    gt::data_color(
    columns = "% = (vs 1)", colors = c("ivory2", "brown1")
  )  %>%
    gt::data_color(
    columns = "% = (vs 2)", colors = c("ivory2", "brown1")
  )  %>%
    gt::data_color(
    columns = "% = (vs 3)", colors = c("ivory2", "brown1")
  )  %>%
  gt::data_color(
    columns = "% / (vs 0)", colors = c("ivory2", "brown1")
  ) %>%
    gt::data_color(
    columns = "% / (vs 1)", colors = c("ivory2", "brown1")
  ) %>%
    gt::data_color(
    columns = "% / (vs 2)", colors = c("ivory2", "brown1")
  ) %>%
    gt::data_color(
    columns = "% / (vs 3)", colors = c("ivory2", "brown1")
  ) %>%
  tab_header(
    title = 'Ataque según bloqueo (nº jugadores) por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia (vs 0)`)
  ) %>%
    tab_footnote(
    footnote = "Ranking mejores equipos en ataque según cuantos bloqueadores hay (1vs0, 1vs1, 1vs2, 1vs3). No penaltis.",
    locations = cells_column_labels(columns = "Rank")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)), 
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )

# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_Ataque_bloqueo, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_Ataque_bloqueo.html")

```


```{r}
# Crear un gráfico de líneas
grafico_ataque_bloqueadores <- ggplot(teams_info, aes(x = reorder(team, -Total_ataques_bl), group = 1)) +
  geom_line(aes(y = Eff_ataques_3, color = "Triple bloqueo"), size = 1) +
  geom_line(aes(y = Eff_ataques_2, color = "Doble bloqueo"), size = 1) +
  geom_line(aes(y = Eff_ataques_1, color = "Bloqueo individual"), size = 1) +
  geom_point(aes(x = reorder(team, -Total_ataques_bl), y = Eff_ataques_3), color = "red", size = 2, shape = 4) +
  geom_point(aes(x = reorder(team, -Total_ataques_bl), y = Eff_ataques_2), color = "red", size = 2, shape = 4) +
  geom_point(aes(x = reorder(team, -Total_ataques_bl), y = Eff_ataques_1), color = "red", size = 2, shape = 4) +
  scale_color_manual(values = c("Triple bloqueo" = "tomato4", "Doble bloqueo" = "sandybrown", "Bloqueo individual" = "snow3"), name = "") +
  labs(x = "",
       y = "Eficiencia",
       title = expression(paste(bold("Eficiencia de ataque VS situación de bloqueo"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotar etiquetas del eje x
    legend.position = "top",  # Mover la leyenda arriba para mejor visibilidad
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid.major = element_line(color = "white"),  # Líneas de la cuadrícula blancas
    plot.background = element_rect(fill = "cornsilk"),  # Color de fondo claro del gráfico
    plot.title = element_text(hjust = 0.5),  # Centrar el título
    plot.subtitle = element_text(hjust = 0.5),  # Centrar el subtítulo
  ) +
  scale_y_continuous(limits = c(0, 0.55), 
                     breaks = seq(0, 0.55, 0.05), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_to_title(x))

print(grafico_ataque_bloqueadores)

ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/ataque_bloqueadores.png", grafico_ataque_bloqueadores, width = 12, height = 6, units = "in")
```




///// MEJORES RECEPTORES


```{r}
mejores_oh <- players_info %>%
  filter(position == "oh") %>%
  filter(Ataque_Tot > 50, Rec_Tot > 50)%>%
  mutate(
      Ataque_Eficacia = ifelse(Ataque_Tot > 0, round((Ataque_Punto / Ataque_Tot) * 100, 2), 0),
      Ataque_Eficiencia = ifelse(Ataque_Tot > 0, round((Ataque_Punto - (Ataque_Error + Ataque_Bloqueado)) / Ataque_Tot, 2), 0),
      
      
      Rec_AVG = ifelse(Rec_Tot > 0, round((Rec_Perf * 5 + Rec_Pos * 3 + Rec_Exc * 2 + Rec_Neg * 1  + Rec_Barra * -1 + Rec_Error * -2) / Rec_Tot, 2), 0),
      
      Saque_AVG = ifelse(Saque_Tot > 0, round((Saque_Punto * 5 + Saque_Barra * 3 + Saque_Pos * 2 + Saque_Exc * 1  + Saque_Neg * -1 + Saque_Error * -2) / Saque_Tot, 2), 0),
      
      Bloqueos_set = round(ifelse(Bloqueo_Tot > 0, round(Bloqueo_Punto / sets_played, 4), 0),2),
      
      AVG = round((Ataque_Eficiencia * 5 + Rec_AVG * 3 + Saque_AVG + Bloqueos_set), 4),
    )


```


```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_mejores_oh <- mejores_oh %>%
  arrange(desc(AVG)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank = Rank,
    Jugador = player_name,
    Sets = sets_played,
    AVG = AVG,
    `Nº ataque` = Ataque_Tot,
    `% Eficiencia` = Ataque_Eficiencia,
    `% Eficacia` = Ataque_Eficacia,
    
    
    `Nº rec` = Rec_Tot,
    `Rec AVG` = Rec_AVG,

    `Nº saque` = Saque_Tot,
    `Saque AVG` = Saque_AVG,
    
    `Nº bloqueo #` = Bloqueo_Punto,
    `Bloqueos/set` = Bloqueos_set
  ) %>%
  gt() %>%
  tab_spanner(
    label = "Ataque",
    columns = c(`Nº ataque`, `% Eficiencia`, `% Eficacia`)
  ) %>%
  tab_spanner(
    label = "Recepción",
    columns = c(`Nº rec`, `Rec AVG`)
  ) %>%
  tab_spanner(
    label = "Saque",
    columns = c(`Nº saque`, `Saque AVG`)
  ) %>%
  tab_spanner(
    label = "Bloqueo",
    columns = c(`Nº bloqueo #`, `Bloqueos/set`)
  ) %>%
  tab_header(
    title = 'Estadísticas por jugador por posición: RECEPTORES',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  gt::data_color(
    columns = "Rec AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
   gt::data_color(
    columns = "% Eficacia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "Bloqueos/set", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  )  %>%
  gt::data_color(
    columns = "AVG", colors = c("ivory2", "deepskyblue2")
  ) %>%
    tab_footnote(
    footnote = "Mínimo de ataques: 50, mínimo de saques: 50",
    locations = cells_title(groups = "title")
  )%>%
 
    tab_footnote(
    footnote = "AVG (media mejor receptor) = (Eficiencia ataque: 5 , Rec AVG: 3, Saque AVG: 1, Bloq/set: 1) / 4",
    locations = cells_column_labels(columns = `AVG`)
  )  %>%
  tab_footnote(
    footnote = "Ataque Eficiencia = Ataque punto - (Ataque error + Ataque bloqueado) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia`)
  ) %>%
  tab_footnote(
    footnote = "Rec AVG = Rec #: 5 , Rec +: 3, Rec !: 2, Rec -: 1, Rec /: -1, Rec =: -2",
    locations = cells_column_labels(columns = `Rec AVG`)
  )  %>%
  tab_footnote(
    footnote = "Saque AVG = Saque #: 5 , Saque +: 3, Saque !: 2, Saque -: 1, Saque /: -1, Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  )   %>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_mejores_oh, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_oh.html")

```



///// MEJORES LIBEROS


```{r}
mejores_lib <- players_info %>%
  filter(position == "ds/l") %>%
  filter(Rec_Tot > 50)%>%
  mutate(
      
      Rec_AVG = ifelse(Rec_Tot > 0, round((Rec_Perf * 5 + Rec_Pos * 3 + Rec_Exc * 2 + Rec_Neg * 1  + Rec_Barra * -1 + Rec_Error * -2) / Rec_Tot, 2), 0),
      
      `% Rec Perf` = round((Rec_Perf / Rec_Tot) * 100, 2),
      `% Rec Pos` = round((Rec_Pos / Rec_Tot) * 100, 2),
      `% Rec Exc` = round((Rec_Exc / Rec_Tot) * 100, 2),
      `% Rec Neg` = round((Rec_Neg / Rec_Tot) * 100, 2),
      `% Rec Barra` = round((Rec_Barra / Rec_Tot) * 100, 2),
      `% Rec Error` = round((Rec_Error / Rec_Tot) * 100, 2),
      `% Rec Eficacia` = ifelse(Rec_Tot > 0, round((Rec_Perf + Rec_Pos) / Rec_Tot * 100, 2), 0),
      `% Rec Eficiencia` = ifelse(Rec_Tot > 0, round((Rec_Perf + Rec_Pos - (Rec_Error + Rec_Barra)) / Rec_Tot, 2), 0),
      
      `% Rec Eficiencia_flot` = ifelse(Rec_Tot > 0, round((Rec_Perf_flot + Rec_Pos_flot - (Rec_Error_flot + Rec_Barra_flot)) / Rec_Tot_flot, 2), 0),
      
      `% Rec Eficiencia_jump` = ifelse(Rec_Tot > 0, round((Rec_Perf_jump + Rec_Pos_jump - (Rec_Error_jump + Rec_Barra_jump)) / Rec_Tot_jump, 2), 0),  
      
    )


```


```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_mejores_lib <- mejores_lib %>%
  arrange(desc(Rec_AVG)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank = Rank,
    Jugador = player_name,
    Sets = sets_played,
    `Nº rec` = Rec_Tot,
    `AVG` = Rec_AVG,
    `% Eficiencia` = `% Rec Eficiencia`,
    `% #` =  `% Rec Perf`,
    `% +` = `% Rec Pos`,
    `% !` = `% Rec Exc`,
    `% -` =  `% Rec Neg`,
    `% /` = `% Rec Barra`,
    `% =` = `% Rec Error`,
    
    `Nº rec (flot)` = Rec_Tot_flot,
    `% Eficiencia (flot)` = `% Rec Eficiencia_flot`,
    
    `Nº rec (salto)` = Rec_Tot_jump,
    `% Eficiencia (salto)` = `% Rec Eficiencia_jump`,
    

  ) %>%
  gt() %>%
  tab_spanner(
    label = "Recepción",
    columns = c(`Nº rec`, `AVG`, `% Eficiencia`, `% #`,`% +`, `% !`,`% -`,`% /`,`% =` )
  )%>%
  tab_spanner(
    label = "Recepción FLOT",
    columns = c(`Nº rec (flot)`, `% Eficiencia (flot)` )
  )%>%
  tab_spanner(
    label = "Recepción SALTO",
    columns = c(`Nº rec (salto)`, `% Eficiencia (salto)` )
  )%>%
  tab_footnote(
    footnote = "Mínimo de recepciones: 50",
    locations = cells_title(groups = "title")
  )%>%
  tab_header(
    title = 'Estadísticas por jugador por posición: LÍBEROS',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  gt::data_color(
    columns = "AVG", colors = c("ivory2", "deepskyblue2")
  )%>%
  gt::data_color(
    columns = `% Eficiencia`, colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = `% Eficiencia (flot)`, colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = `% Eficiencia (salto)`, colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = `% /`, colors = c("ivory2", "brown1")
  )%>%
  gt::data_color(
    columns = `% =`, colors = c("ivory2", "brown1")
  )%>%
  tab_footnote(
    footnote = "AVG = Rec #: 5 , Rec +: 3, Rec !: 2, Rec -: 1, Rec /: -1, Rec =: -2",
    locations = cells_column_labels(columns = `AVG`)
  )  %>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_mejores_lib, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_lib.html")

```





///// MEJORES CENTRALES

```{r}
mejores_mb <- players_info %>%
  filter(position == "mb") %>%
  filter(Ataque_Tot > 50, Saque_Tot > 50)%>%
  mutate(
      Ataque_Eficacia = ifelse(Ataque_Tot > 0, round((Ataque_Punto / Ataque_Tot) * 100, 2), 0),
      Ataque_Eficiencia = ifelse(Ataque_Tot > 0, round((Ataque_Punto - (Ataque_Error + Ataque_Bloqueado)) / Ataque_Tot, 2), 0),
      
      Saque_AVG = ifelse(Saque_Tot > 0, round((Saque_Punto * 5 + Saque_Barra * 3 + Saque_Pos * 2 + Saque_Exc * 1  + Saque_Neg * -1 + Saque_Error * -2) / Saque_Tot, 2), 0),
      
      Bloqueos_set = round(ifelse(Bloqueo_Tot > 0, round(Bloqueo_Punto / sets_played, 4), 0),2),
      
      AVG = round((Ataque_Eficiencia * 6 + Bloqueos_set * 3 + Saque_AVG), 3),
    )


```


```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_mejores_mb <- mejores_mb %>%
  arrange(desc(AVG)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank = Rank,
    Jugador = player_name,
    Sets = sets_played,
    AVG = AVG,
    `Nº ataque` = Ataque_Tot,
    `% Eficiencia` = Ataque_Eficiencia,
    `% Eficacia` = Ataque_Eficacia,


    `Nº saque` = Saque_Tot,
    `Saque AVG` = Saque_AVG,
    
    `Nº bloqueo` = Bloqueo_Punto,
    `Bloqueos/set` = Bloqueos_set
  ) %>%
  gt() %>%
  tab_spanner(
    label = "Ataque",
    columns = c(`Nº ataque`, `% Eficiencia`, `% Eficacia`)
  ) %>%
  tab_spanner(
    label = "Saque",
    columns = c(`Nº saque`, `Saque AVG`)
  ) %>%
  tab_spanner(
    label = "Bloqueo",
    columns = c(`Nº bloqueo`, `Bloqueos/set`)
  ) %>%
  tab_header(
    title = 'Estadísticas por jugador por posición: CENTRALES',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  gt::data_color(
    columns = "% Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
   gt::data_color(
    columns = "% Eficacia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "Bloqueos/set", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  )  %>%
  gt::data_color(
    columns = "AVG", colors = c("ivory2", "deepskyblue2")
  ) %>%
 
    tab_footnote(
    footnote = "AVG (media mejor central) = (Eficiencia ataque: 6 , bloq/set: 3, Saque AVG: 1) / 3",
    locations = cells_column_labels(columns = `AVG`)
  )  %>%
  tab_footnote(
    footnote = "Ataque Eficiencia = Ataque punto - (Ataque error + Ataque bloqueado) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia`)
  ) %>%
  tab_footnote(
    footnote = "Saque AVG = Saque #: 5 , Saque +: 3, Saque !: 2, Saque -: 1, Saque /: -1, Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  )   %>%
    tab_footnote(
    footnote = "Mínimo de ataques: 50, mínimo de saques: 50",
    locations = cells_title(groups = "title")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_mejores_mb, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_mb.html")

```




///// MEJORES OPUESTOS

```{r}
mejores_opp <- players_info %>%
  filter(position == "opp") %>%
  filter(Ataque_Tot > 50, Saque_Tot > 50)%>%
  mutate(
      Ataque_Eficacia = ifelse(Ataque_Tot > 0, round((Ataque_Punto / Ataque_Tot) * 100, 2), 0),
      Ataque_Eficiencia = ifelse(Ataque_Tot > 0, round((Ataque_Punto - (Ataque_Error + Ataque_Bloqueado)) / Ataque_Tot, 2), 0),
      
      Saque_AVG = ifelse(Saque_Tot > 0, round((Saque_Punto * 5 + Saque_Barra * 3 + Saque_Pos * 2 + Saque_Exc * 1  + Saque_Neg * -1 + Saque_Error * -2) / Saque_Tot, 2), 0),
      
      Bloqueos_set = ifelse(Bloqueo_Tot > 0, round(Bloqueo_Punto / sets_played, 4), 0),
      
      AVG = round((Ataque_Eficiencia * 7 + Bloqueos_set + Saque_AVG * 2), 3),
    )


```


```{r}
library(gt)

# Crear tabla combinada con spanners para cada tipo de recepción
tabla_mejores_opp <- mejores_opp %>%
  arrange(desc(AVG)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank = Rank,
    Jugador = player_name,
    Sets = sets_played,
    AVG = AVG,
    `Nº ataque` = Ataque_Tot,
    `% Eficiencia` = Ataque_Eficiencia,
    `% Eficacia` = Ataque_Eficacia,


    `Nº saque` = Saque_Tot,
    `Saque AVG` = Saque_AVG,
    
    `Nº bloqueo` = Bloqueo_Punto,
    `Bloqueos/set` = Bloqueos_set
  ) %>%
  gt() %>%
  tab_spanner(
    label = "Ataque",
    columns = c(`Nº ataque`, `% Eficiencia`, `% Eficacia`)
  ) %>%
  tab_spanner(
    label = "Saque",
    columns = c(`Nº saque`, `Saque AVG`)
  ) %>%
  tab_spanner(
    label = "Bloqueo",
    columns = c(`Nº bloqueo`, `Bloqueos/set`)
  ) %>%
  gt::data_color(
    columns = "% Eficiencia", colors = c("ivory2", "palegreen4")
  )%>%
   gt::data_color(
    columns = "% Eficacia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "Bloqueos/set", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  )  %>%
  gt::data_color(
    columns = "AVG", colors = c("ivory2", "deepskyblue2")
  ) %>%
    tab_header(
    title = 'Estadísticas por jugador por posición: OPUESTOS',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
 
  tab_footnote(
    footnote = "AVG (media mejor opuesto) = (Eficiencia ataque: 7, Saque AVG: 2, bloq/set: 1) / 3",
    locations = cells_column_labels(columns = `AVG`)
  )  %>%
  tab_footnote(
    footnote = "Ataque Eficiencia = Ataque punto - (Ataque error + Ataque bloqueado) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia`)
  ) %>%
  tab_footnote(
    footnote = "Saque AVG = Saque #: 5 , Saque +: 3, Saque !: 2, Saque -: 1, Saque /: -1, Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  )%>%    
  tab_footnote(
    footnote = "Mínimo de ataques: 50, mínimo de saques: 50",
    locations = cells_title(groups = "title")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  ))

# Guardar la tabla como un archivo HTML
gtsave(tabla_mejores_opp, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/jugadores_opp.html")

```




//// BLOQUEO



```{r}
teams_info <- teams_info %>%
  left_join(
    df %>%
      filter( skill == "block") %>% 
      group_by(team) %>%                         
      summarise(
                Block_Tot = n(),
                Block_Punto = sum(evaluation_code == "#"),
                Block_Pos = sum(evaluation_code == "+"),
                Block_Exc = sum(evaluation_code == "!"),
                Block_Neg = sum(evaluation_code == "-"),
                Block_Barra = sum(evaluation_code == "/"),
                Block_Error = sum(evaluation_code == "=")

              ),
            by = "team")%>%
     mutate(
    Bloqueos_set = round(ifelse(Block_Tot > 0, round(Block_Punto / sets_played, 4), 0),2),
    `% Block Neg` = round((Block_Neg / Block_Tot) * 100, 2),
    `% Block Error` = round((Block_Error / Block_Tot) * 100, 2),
    `% Block Exc` = round((Block_Exc / Block_Tot) * 100, 2),
    `% Block Pos` = round((Block_Pos / Block_Tot) * 100, 2),
    `% Block Barra` = round((Block_Barra / Block_Tot) * 100, 2),
    `% Block Punto` = round((Block_Punto / Block_Tot) * 100, 2)
  )
```


```{r}
library(gt)

# Crear la tabla con la información de teams_info
tabla_equipos_bloqueo <- teams_info  %>%
  
  arrange(desc(Bloqueos_set)) %>% 
  mutate(Rank = row_number())%>% 
  select(
    Rank,
    Equipo = team,
    Sets = sets_played,
    `Bloqueos/set` = Bloqueos_set,
    `Nº Bloqueo` = Block_Tot,
    Punto = Block_Punto,
    `% Punto` = `% Block Punto`,
    Positivo = Block_Pos,
    `% Pos` = `% Block Pos`,
    
    `Error` = Block_Error,
    `% Error` = `% Block Error`
  ) %>%
  gt() %>%
  cols_label(
    Equipo = 'Equipo',
    Sets = 'Sets',
  ) %>%
  gt::data_color(
    columns = "% Punto", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "Bloqueos/set", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Pos", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Error", colors = c("ivory2", "brown1")
  )  %>%
  tab_header(
    title = 'Bloqueo por equipo',
    subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos"
  ) %>%
  tab_footnote(
    footnote = "Bloqueo/Set: bloqueos punto por set",
    locations = cells_column_labels(columns = `Bloqueos/set`)
  ) %>%
  tab_footnote(
    footnote = "Ranking mejores equipos en bloqueo",
    locations = cells_column_labels(columns = `Rank`)
  ) %>%
  tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  
  text_transform(
    locations = cells_body(vars(Equipo)),  # Aplicar la transformación solo a la columna "Equipo"
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )


# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_bloqueo, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_bloqueo.html")


```


```{r}
library(ggplot2)

# Crear el gráfico
grafico_bloqueo <- ggplot(teams_info, aes(x = `Block_Tot`, y = `Bloqueos_set`, label = team, fill = team))  +
  scale_x_continuous(limits = c(800, 1200), 
                     breaks = seq(800, 1200, 50), 
                     labels = scales::number_format(accuracy = 1), 
                     expand = c(0, 0)) +
  scale_y_continuous(limits = c(1.50, 2.75), 
                     breaks = seq(1.50, 2.75, 0.1), 
                     labels = scales::number_format(accuracy = 0.01), 
                     expand = c(0, 0)) +
  geom_image(aes(image = logo), size = 0.1, nudge_y = 0.01) +  # Ajusta el tamaño aquí
  scale_fill_manual(values = rainbow(length(unique(teams_info$team)))) +
  labs(x = "Nº bloqueos",
       y = "Bloqueos/set",
       title = expression(paste(bold("Bloqueos/set por equipo"))),
       subtitle = "Superliga 1 Masculina 2023-24 | 22 jornadas, 132 partidos",
       caption = "Datos y gráfico: @adrianglez77") +
  theme_minimal() +
  theme(
    aspect.ratio = 1/asp_ratio,
    panel.background = element_rect(fill = "cornsilk"),  # Color de fondo claro
    panel.grid = element_line(color = "beige"),         # Líneas de la cuadrícula claras
    text = element_text(color = "black", size = 12),     # Color y tamaño del texto
    axis.text = element_text(size = 12),                 # Tamaño del texto del eje
    axis.title = element_text(size = 14),                # Tamaño del título del eje
    axis.line = element_line(color = "beige"),           # Color de la línea del eje
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5), # Tamaño y estilo del título del gráfico
    plot.subtitle = element_text(size = 14, hjust = 0.5),             # Tamaño del subtítulo del gráfico
    plot.caption = element_text(size = 10),              # Tamaño de la leyenda del gráfico
    axis.ticks = element_blank(),                        # Elimina las marcas de los ejes
    axis.ticks.length = unit(0, "mm"),                   # Establece la longitud de las marcas de los ejes
    axis.ticks.margin = unit(0, "mm"),                    # Establece el margen de las marcas de los ejes
    axis.text.y = element_text(vjust = -0.05),
    axis.text.x = element_text(hjust = +0.05)
  )+
  geom_point(aes(x = `Block_Tot`, y = `Bloqueos_set`), color = "black", size = 1.5) +
  guides(fill = "none")+
  theme(aspect.ratio = 1/asp_ratio, plot.background = element_rect(fill = "cornsilk",color = "cornsilk")
)    


# Mostrar el gráfico
print(grafico_bloqueo)

# Guardar la tabla como un archivo HTML
ggsave("F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/bloqueo.png", plot = grafico_bloqueo, width = 8, height = 6, units = "in", dpi = 300)

```



//// EQUIPOS TODO GENERAL



```{r}
# Definir el orden deseado de los equipos
orden_equipos <- c(
  "cv guaguas", "unicaja costa de almería", "grupo herce soria", 
  "pamesa teruel voleibol", "cv melilla", "cisneros alter", 
  "leleman conqueridor upv", "cv san roque", "conectabalear cv manacor", 
  "arenal emevé", "club vóley palma", "volei villena petrer"
)

# Crear la tabla con la información de teams_info
tabla_equipos_todo <- teams_info %>%
  mutate(team = factor(team, levels = orden_equipos)) %>%  # Convertir la columna Equipo en un factor con el orden deseado
  arrange(team) %>%  # Ordenar la tabla según el factor
  select(
    Equipo = team,
    Partidos = matches_played,
    Sets = sets_played,
    `% SO` = Porcentaje_SO,
    `% BP` = Porcentaje_BP,
    
    `Nº Saque` = Saque_Tot,
    `Saque =` = Saque_Error,
    `Saque /` = Saque_Barra,
    `Saque #` = Saque_Punto,
    `Saque AVG` = Saque_AVG,

    `Nº Rec` = Rec_Tot,
    `Rec =` = Rec_Error,
    `Rec /` = Rec_Barra,
    `Rec +` = Rec_Pos,
    `Rec #` = Rec_Perf,
    `Rec AVG` = Rec_AVG,
    
    `Nº Ataque` = Ataque_Tot,
    `Ataque =` = Ataque_Error,
    `Ataque /` = Ataque_Barra,
    `Ataque #` = Ataque_Perf,
    `% Eficacia` = `% Ataque Eficacia`,
    `% Eficiencia` = `% Ataque Eficiencia`,
    
    
    `Nº Bloqueo` = Block_Tot,
    `Bloqueo #` = Block_Punto,
    `Bloqueos # x set` = Bloqueos_set
    
  ) %>%
  gt() %>%
  cols_label(
    Equipo = 'Equipo',
    Sets = 'Sets',
  ) %>%
  tab_spanner(
    label = "Saque",
    columns = c(`Nº Saque`, `Saque =`, `Saque /`, `Saque #`, `Saque AVG`)
  ) %>%
  tab_spanner(
    label = "Recepción",
    columns = c(`Nº Rec`, `Rec =`, `Rec /`, `Rec +`, `Rec #`,`Rec AVG`)
  ) %>%
  tab_spanner(
    label = "Ataque",
    columns = c(`Nº Ataque`, `Ataque =`, `Ataque /`, `Ataque #`, `% Eficacia`, `% Eficiencia`)
  ) %>%
    tab_spanner(
    label = "Bloqueo",
    columns = c(`Nº Bloqueo`,  `Bloqueo #`, `Bloqueos # x set`)
  ) %>%
  gt::data_color(
    columns = "% SO", colors = c("ivory2", "deepskyblue2")
  )%>%
  gt::data_color(
    columns = "% BP", colors = c("ivory2", "deepskyblue2")
  )%>%
  gt::data_color(
    columns = "Saque AVG", colors = c("ivory2", "palegreen4")
  )%>%
    gt::data_color(
    columns = "Rec AVG", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Eficacia", colors = c("ivory2", "palegreen4")
  )%>%
  gt::data_color(
    columns = "% Eficiencia", colors = c("ivory2", "palegreen4")
  )  %>%
  gt::data_color(
    columns = "Bloqueos # x set", colors = c("ivory2", "palegreen4")
  ) %>%
  tab_header(
    title = md("<img src='https://www.rfevb.com/Files/Descargas/svm_horizontal-pdfEs20140821113522.jpg' style='height:40px;'>"),
    subtitle = md("<span style='font-weight:bold; font-size: 20px; font-family: Chivo'> Estadísticas generales por equipo</span>")
  ) %>%
  tab_footnote(
    footnote = "Ataque eficiencia = Ataque punto - (Ataque bloqueado + Ataque error) / Total ataques",
    locations = cells_column_labels(columns = `% Eficiencia`)
  ) %>%
  tab_footnote(
    footnote = "Saque AVG = Valoración media atendiendo a: Saque #: 5, Saque /: 3, Saque +: 2, Saque !: 1, Saque -: -1,  Saque =: -2",
    locations = cells_column_labels(columns = `Saque AVG`)
  ) %>%
  tab_footnote(
    footnote = "Rec AVG = Valoración media atendiendo a: Rec #: 5, Rec +: 3, Rec !: 2, Rec -: 1, Rec /: -1,  Rec =: -2",
    locations = cells_column_labels(columns = `Rec AVG`)
  ) %>%
  tab_footnote(
    footnote = "Resumen estadísticas generales por fundamento y por equipo | Liga regular 2023-24",
    locations = cells_title(groups = "subtitle")
  )%>%
    tab_style(
    style = list(cell_fill(color = "gray35"), cell_text(color = "white", style = "italic")),
    locations = list(cells_footnotes(), cells_source_notes())
  ) %>%
  tab_options(
    column_labels.font.weight = "bold",
    heading.align = "center",
    table.background.color = "cornsilk",
    column_labels.background.color = "cornsilk",
    table.font.names = "Inconsolata",
    data_row.padding = px(0)
  )%>%
  cols_align(
    align = 'center',
    columns = everything()
  ) %>%
  tab_source_note(source_note = md(
    "Diseño y datos: @adrianglez77"
  )) %>%
  text_transform(
    locations = cells_body(vars(Equipo)), 
    fn = function(x) {
      map_chr(x, ~paste0("<img src='", teams_info$logo[match(.x, teams_info$team)], "' width='25px'>"))
    }
  )


# Guardar la tabla como un archivo HTML
gtsave(tabla_equipos_todo, "F:/Club Voleibol San Roque/2023-2024/SM1 2023-2024/SCOUT/Practicas/Final/equipos_todo.html")
```
